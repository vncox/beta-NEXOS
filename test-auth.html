<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebas del Sistema de Autenticaci√≥n - Nexos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #e0f7fa, #bbdefb);
            padding: 2rem;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #4a90e2;
            margin-bottom: 1rem;
        }
        h2 {
            color: #50c878;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .test-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }
        button {
            background: #50c878;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        button.danger {
            background: #ff6b6b;
        }
        button.secondary {
            background: #4a90e2;
        }
        .output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Pruebas del Sistema de Autenticaci√≥n</h1>
        <p>Panel de pruebas para verificar el funcionamiento del sistema de autenticaci√≥n de Nexos.</p>

        <h2>üìä Estado del Sistema</h2>
        <div class="test-section">
            <button onclick="verificarEstado()">Verificar Estado</button>
            <button onclick="verUsuarios()">Ver Usuarios</button>
            <button onclick="verEmpresas()">Ver Empresas</button>
            <button onclick="verSesion()">Ver Sesi√≥n Actual</button>
            <div id="outputEstado" class="output" style="display: none;"></div>
        </div>

        <h2>üë§ Pruebas de Login</h2>
        <div class="test-section">
            <button onclick="loginAdminUser()">Login Admin Usuario</button>
            <button onclick="loginAdminEmpresa()">Login Admin Empresa</button>
            <button onclick="loginInvalido()">Login Inv√°lido (debe fallar)</button>
            <button class="danger" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
            <div id="outputLogin" class="output" style="display: none;"></div>
        </div>

        <h2>üìù Pruebas de Registro</h2>
        <div class="test-section">
            <button onclick="registrarUsuarioTest()">Registrar Usuario de Prueba</button>
            <button onclick="registrarEmpresaTest()">Registrar Empresa de Prueba</button>
            <button onclick="registroDuplicado()">Registro Duplicado (debe fallar)</button>
            <div id="outputRegistro" class="output" style="display: none;"></div>
        </div>

        <h2>‚úèÔ∏è Pruebas de Actualizaci√≥n</h2>
        <div class="test-section">
            <button onclick="actualizarDatosTest()">Actualizar Datos de Usuario</button>
            <button onclick="cambiarPasswordTest()">Cambiar Contrase√±a</button>
            <button onclick="actualizarConfigTest()">Actualizar Configuraci√≥n</button>
            <div id="outputActualizar" class="output" style="display: none;"></div>
        </div>

        <h2>üóëÔ∏è Gesti√≥n de Datos</h2>
        <div class="test-section">
            <button class="secondary" onclick="contarRegistros()">Contar Registros</button>
            <button class="secondary" onclick="exportarDatos()">Exportar Datos</button>
            <button class="danger" onclick="limpiarTodo()">‚ö†Ô∏è Limpiar Todo (Reset)</button>
            <div id="outputGestion" class="output" style="display: none;"></div>
        </div>

        <h2>üîó Enlaces R√°pidos</h2>
        <div class="test-section">
            <button onclick="window.location.href='index.html'">Ir a Inicio</button>
            <button onclick="window.location.href='login.html'">Ir a Login</button>
            <button onclick="window.location.href='perfil.html'">Ir a Perfil Usuario</button>
            <button onclick="window.location.href='perfil-empresa.html'">Ir a Perfil Empresa</button>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        function mostrarOutput(id, contenido, tipo = 'info') {
            const output = document.getElementById(id);
            output.style.display = 'block';
            output.textContent = contenido;
        }

        function verificarEstado() {
            const isLoggedIn = auth.isLoggedIn();
            const session = auth.getSession();
            const account = auth.getCurrentAccount();
            
            let resultado = `Sistema de Autenticaci√≥n Nexos
            
Estado: ${isLoggedIn ? '‚úÖ Sesi√≥n Activa' : '‚ùå Sin Sesi√≥n'}

`;
            
            if (isLoggedIn && session) {
                resultado += `Sesi√≥n Actual:
- Usuario: ${session.username}
- Tipo: ${session.type}
- Role: ${session.role}
- Login: ${new Date(session.loginTime).toLocaleString()}
`;
                
                if (account) {
                    resultado += `
Datos de Cuenta:
- ID: ${account.id}
- Email: ${account.email}
`;
                    if (account.nombre) {
                        resultado += `- Nombre: ${account.nombre} ${account.apellido}
`;
                    }
                    if (account.razonSocial) {
                        resultado += `- Raz√≥n Social: ${account.razonSocial}
- RUT: ${account.rut}
`;
                    }
                }
            }
            
            mostrarOutput('outputEstado', resultado);
        }

        function verUsuarios() {
            const users = auth.getUsers();
            let resultado = `Total de Usuarios: ${users.length}

`;
            users.forEach((u, i) => {
                resultado += `${i + 1}. ${u.username} - ${u.nombre} ${u.apellido} (${u.email})
   Role: ${u.role} | Registrado: ${new Date(u.fechaRegistro).toLocaleDateString()}

`;
            });
            mostrarOutput('outputEstado', resultado);
        }

        function verEmpresas() {
            const empresas = auth.getEmpresas();
            let resultado = `Total de Empresas: ${empresas.length}

`;
            empresas.forEach((e, i) => {
                resultado += `${i + 1}. ${e.username} - ${e.razonSocial} (${e.email})
   RUT: ${e.rut} | Role: ${e.role} | Registrado: ${new Date(e.fechaRegistro).toLocaleDateString()}

`;
            });
            mostrarOutput('outputEstado', resultado);
        }

        function verSesion() {
            const session = auth.getSession();
            if (!session) {
                mostrarOutput('outputEstado', 'No hay sesi√≥n activa');
                return;
            }
            
            const resultado = JSON.stringify(session, null, 2);
            mostrarOutput('outputEstado', resultado);
        }

        function loginAdminUser() {
            const result = auth.login('admin', '1234', 'user');
            mostrarOutput('outputLogin', JSON.stringify(result, null, 2));
            
            if (result.success) {
                setTimeout(() => {
                    alert('Login exitoso! Recargando p√°gina...');
                    location.reload();
                }, 1500);
            }
        }

        function loginAdminEmpresa() {
            const result = auth.login('admin', '1234', 'empresa');
            mostrarOutput('outputLogin', JSON.stringify(result, null, 2));
            
            if (result.success) {
                setTimeout(() => {
                    alert('Login exitoso! Recargando p√°gina...');
                    location.reload();
                }, 1500);
            }
        }

        function loginInvalido() {
            const result = auth.login('usuario_invalido', 'password_incorrecta', 'user');
            mostrarOutput('outputLogin', JSON.stringify(result, null, 2));
        }

        function cerrarSesion() {
            const result = auth.logout();
            mostrarOutput('outputLogin', JSON.stringify(result, null, 2));
            setTimeout(() => location.reload(), 1000);
        }

        function registrarUsuarioTest() {
            const timestamp = Date.now();
            const userData = {
                username: `test_user_${timestamp}`,
                nombre: 'Test',
                apellido: 'Usuario',
                email: `test_${timestamp}@nexos.com`,
                telefono: '+56 9 1234 5678',
                password: 'test1234'
            };
            
            const result = auth.registerUser(userData);
            mostrarOutput('outputRegistro', JSON.stringify(result, null, 2));
        }

        function registrarEmpresaTest() {
            const timestamp = Date.now();
            const empresaData = {
                username: `test_empresa_${timestamp}`,
                razonSocial: 'Empresa Test SA',
                rut: `${timestamp.toString().substring(0, 8)}-9`,
                email: `empresa_${timestamp}@nexos.com`,
                telefono: '+56 2 2345 6789',
                direccion: 'Calle Test 123',
                sitioWeb: 'https://test.com',
                password: 'test1234'
            };
            
            const result = auth.registerEmpresa(empresaData);
            mostrarOutput('outputRegistro', JSON.stringify(result, null, 2));
        }

        function registroDuplicado() {
            const userData = {
                username: 'admin',
                nombre: 'Duplicado',
                apellido: 'Test',
                email: 'duplicado@nexos.com',
                password: 'test1234'
            };
            
            const result = auth.registerUser(userData);
            mostrarOutput('outputRegistro', JSON.stringify(result, null, 2));
        }

        function actualizarDatosTest() {
            if (!auth.isLoggedIn()) {
                mostrarOutput('outputActualizar', 'Error: Debes iniciar sesi√≥n primero');
                return;
            }
            
            const account = auth.getCurrentAccount();
            const session = auth.getSession();
            
            let result;
            if (session.type === 'user') {
                result = auth.updateUser(account.id, {
                    telefono: '+56 9 8888 8888'
                });
            } else {
                result = auth.updateEmpresa(account.id, {
                    telefono: '+56 2 9999 9999'
                });
            }
            
            mostrarOutput('outputActualizar', JSON.stringify(result, null, 2));
        }

        function cambiarPasswordTest() {
            if (!auth.isLoggedIn()) {
                mostrarOutput('outputActualizar', 'Error: Debes iniciar sesi√≥n primero');
                return;
            }
            
            const result = auth.changePassword('1234', 'nueva1234');
            mostrarOutput('outputActualizar', JSON.stringify(result, null, 2));
            
            if (result.success) {
                alert('Contrase√±a cambiada. Cambiando de vuelta a "1234"...');
                setTimeout(() => {
                    auth.changePassword('nueva1234', '1234');
                }, 1000);
            }
        }

        function actualizarConfigTest() {
            if (!auth.isLoggedIn()) {
                mostrarOutput('outputActualizar', 'Error: Debes iniciar sesi√≥n primero');
                return;
            }
            
            const result = auth.updateConfig({
                tema: 'dark',
                notificaciones: false
            });
            
            mostrarOutput('outputActualizar', JSON.stringify(result, null, 2));
        }

        function contarRegistros() {
            const users = auth.getUsers();
            const empresas = auth.getEmpresas();
            const session = auth.getSession();
            
            const resultado = `Estad√≠sticas:
            
üë• Usuarios registrados: ${users.length}
üè¢ Empresas registradas: ${empresas.length}
üìä Total de cuentas: ${users.length + empresas.length}
üîê Sesi√≥n activa: ${session ? 'S√≠' : 'No'}

Memoria localStorage:
${JSON.stringify({
    nexos_users: users.length + ' usuarios',
    nexos_empresas: empresas.length + ' empresas',
    nexos_session: session ? 'Activa' : 'Inactiva'
}, null, 2)}`;
            
            mostrarOutput('outputGestion', resultado);
        }

        function exportarDatos() {
            const datos = {
                usuarios: auth.getUsers(),
                empresas: auth.getEmpresas(),
                sesion: auth.getSession(),
                fecha_exportacion: new Date().toISOString()
            };
            
            const json = JSON.stringify(datos, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nexos_backup_${Date.now()}.json`;
            a.click();
            
            mostrarOutput('outputGestion', 'Datos exportados correctamente. Verifica tu carpeta de descargas.');
        }

        function limpiarTodo() {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto borrar√° TODOS los datos (usuarios, empresas y sesi√≥n). Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            localStorage.removeItem('nexos_users');
            localStorage.removeItem('nexos_empresas');
            localStorage.removeItem('nexos_session');
            
            mostrarOutput('outputGestion', 'Todos los datos han sido eliminados. Recargando p√°gina...');
            
            setTimeout(() => location.reload(), 2000);
        }
    </script>
</body>
</html>
