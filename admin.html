<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="images/favicon.svg?v=2" type="image/svg+xml">
    <link rel="shortcut icon" href="images/favicon.svg?v=2" type="image/svg+xml">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 100px auto 50px;
            padding: 0 20px;
        }

        .admin-header {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 50%, #50c878 100%);
            padding: 3rem 3rem;
            border-radius: 20px;
            margin-bottom: 3rem;
            box-shadow: 0 15px 40px rgba(74, 144, 226, 0.25);
            position: relative;
            overflow: hidden;
        }

        .admin-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.15) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .admin-header-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .admin-header-left h1 {
            margin: 0 0 0.8rem 0;
            color: white;
            font-size: 2.8rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .admin-header-left h1 i {
            font-size: 3.2rem;
        }

        .admin-header-left p {
            margin: 0;
            color: rgba(255,255,255,0.95);
            font-size: 1.15rem;
            font-weight: 500;
        }

        .admin-session-card {
            background: rgba(255,255,255,0.25);
            padding: 1.2rem 2rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            text-align: center;
            min-width: 200px;
        }

        .admin-session-card p:first-child {
            margin: 0;
            color: rgba(255,255,255,0.9);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .admin-session-card p:last-child {
            margin: 0.5rem 0 0 0;
            color: white;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .admin-session-card i {
            color: #ffd700;
            font-size: 1.4rem;
        }

        @media (max-width: 768px) {
            .admin-header-content {
                flex-direction: column;
                text-align: center;
            }

            .admin-header-left h1 {
                font-size: 2rem;
                justify-content: center;
            }

            .admin-session-card {
                width: 100%;
            }
        }

        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: white;
            padding: 0.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .admin-tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-tab.active {
            color: white;
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .admin-tab:hover {
            color: var(--primary);
            background: rgba(74, 144, 226, 0.1);
        }

        .admin-tab.active:hover {
            color: white;
            background: linear-gradient(135deg, #357abd 0%, #2868a8 100%);
        }

        .admin-tab i {
            font-size: 1.1rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .stat-card.pending i { color: #f39c12; }
        .stat-card.approved i { color: #27ae60; }
        .stat-card.rejected i { color: #e74c3c; }
        .stat-card.users i { color: #3498db; }

        .stat-card h3 {
            font-size: 2.5rem;
            margin: 0.5rem 0;
            color: var(--dark);
        }

        .stat-card p {
            color: #666;
            margin: 0;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge.approved {
            background: #d4edda;
            color: #155724;
        }

        .badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.admin {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge.user {
            background: #e7e7e7;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
        }

        .btn-approve:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-reject {
            background: #e74c3c;
            color: white;
        }

        .btn-reject:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-view {
            background: #3498db;
            color: white;
        }

        .btn-view:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-edit:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary);
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
        }

        .detail-row {
            display: flex;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 600;
            width: 150px;
            color: #666;
        }

        .detail-value {
            flex: 1;
            color: var(--dark);
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <a href="index.html" class="logo">
                <i class="fas fa-heart"></i>
                <span>Nexos</span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="subastas.html">Subastas</a></li>
                <li><a href="rifas.html">Rifas</a></li>
                <li><a href="ventas.html">Ventas</a></li>
                <li><a href="causas.html">Causas</a></li>
                <li><a href="empresas.html">Empresas</a></li>
                <li><a href="contacto.html">Contacto</a></li>
            </ul>
            <button class="cta-button" onclick="window.location.href='login.html'">Iniciar Sesi贸n</button>
        </nav>
    </header>

    <div class="admin-container">
        <!-- Header Mejorado -->
        <div class="admin-header">
            <div class="admin-header-content">
                <div class="admin-header-left">
                    <h1>
                        <i class="fas fa-user-shield"></i>
                        Panel de Administraci贸n
                    </h1>
                    <p>
                        Gestiona usuarios, empresas y solicitudes del sistema
                    </p>
                </div>
                <div class="admin-session-card">
                    <p>Sesi贸n activa como</p>
                    <p>
                        <i class="fas fa-crown"></i> Administrador
                    </p>
                </div>
            </div>
        </div>

        <!-- Estad铆sticas -->
        <div class="stats-grid">
            <div class="stat-card pending">
                <i class="fas fa-clock"></i>
                <h3 id="stat-pending">0</h3>
                <p>Solicitudes Pendientes</p>
            </div>
            <div class="stat-card approved">
                <i class="fas fa-check-circle"></i>
                <h3 id="stat-approved">0</h3>
                <p>Empresas Aprobadas</p>
            </div>
            <div class="stat-card rejected">
                <i class="fas fa-times-circle"></i>
                <h3 id="stat-rejected">0</h3>
                <p>Solicitudes Rechazadas</p>
            </div>
            <div class="stat-card users">
                <i class="fas fa-users"></i>
                <h3 id="stat-users">0</h3>
                <p>Usuarios Totales</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="admin-tabs">
            <button class="admin-tab active" onclick="cambiarTab('dashboard', this)">
                <i class="fas fa-tachometer-alt"></i> Dashboard Principal
            </button>
            <button class="admin-tab" onclick="cambiarTab('cuentas', this)">
                <i class="fas fa-users-cog"></i> Gesti贸n de Cuentas
            </button>
            <button class="admin-tab" onclick="cambiarTab('finanzas', this)">
                <i class="fas fa-wallet"></i> Gesti贸n Financiera
            </button>
            <button class="admin-tab" onclick="cambiarTab('subastas', this)">
                <i class="fas fa-gavel"></i> Gesti贸n de Subastas
            </button>
            <button class="admin-tab" onclick="cambiarTab('rifas', this)">
                <i class="fas fa-ticket-alt"></i> Gesti贸n de Rifas
            </button>
            <button class="admin-tab" onclick="cambiarTab('ventas', this)">
                <i class="fas fa-shopping-cart"></i> Gesti贸n de Ventas
            </button>
            <button class="admin-tab" onclick="cambiarTab('solicitudes', this)">
                <i class="fas fa-clock"></i> Solicitudes Pendientes
            </button>
            <button class="admin-tab" onclick="cambiarTab('sistema', this)">
                <i class="fas fa-cogs"></i> Sistema
            </button>
        </div>

        <!-- Tab: Dashboard Principal -->
        <div id="tab-dashboard" class="tab-content active">
            <!-- Estad铆sticas R谩pidas -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Total Cuentas -->
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 1.8rem; border-radius: 15px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2); color: white;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <i class="fas fa-users-cog" style="font-size: 2.5rem; opacity: 0.9;"></i>
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Total de Cuentas</p>
                            <h3 style="margin: 0.3rem 0 0 0; font-size: 2.2rem; font-weight: 700;" id="dash-total-cuentas">0</h3>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; font-size: 0.85rem; opacity: 0.9;">
                        <span><i class="fas fa-user"></i> <span id="dash-total-users">0</span> Usuarios</span>
                        <span><i class="fas fa-building"></i> <span id="dash-total-empresas">0</span> Empresas</span>
                    </div>
                </div>

                <!-- Circulaci贸n Total -->
                <div style="background: linear-gradient(135deg, #f093fb, #f5576c); padding: 1.8rem; border-radius: 15px; box-shadow: 0 8px 25px rgba(240, 147, 251, 0.2); color: white;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <i class="fas fa-coins" style="font-size: 2.5rem; opacity: 0.9;"></i>
                        <div style="flex: 1; min-width: 0;">
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Circulaci贸n Total</p>
                            <h3 style="margin: 0.3rem 0 0 0; font-size: 1.8rem; font-weight: 700; word-break: break-word;" id="dash-circulacion-total">$0</h3>
                        </div>
                    </div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">
                        <i class="fas fa-exchange-alt"></i> <span id="dash-total-transacciones">0</span> transacciones
                    </div>
                </div>

                <!-- Subastas Activas -->
                <div style="background: linear-gradient(135deg, #fa709a, #fee140); padding: 1.8rem; border-radius: 15px; box-shadow: 0 8px 25px rgba(250, 112, 154, 0.2); color: white;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <i class="fas fa-gavel" style="font-size: 2.5rem; opacity: 0.9;"></i>
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Subastas Activas</p>
                            <h3 style="margin: 0.3rem 0 0 0; font-size: 2.2rem; font-weight: 700;" id="dash-subastas-activas">0</h3>
                        </div>
                    </div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">
                        <i class="fas fa-fire"></i> En curso ahora mismo
                    </div>
                </div>

                <!-- Solicitudes Pendientes -->
                <div style="background: linear-gradient(135deg, #fbc2eb, #a6c1ee); padding: 1.8rem; border-radius: 15px; box-shadow: 0 8px 25px rgba(251, 194, 235, 0.2); color: white;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <i class="fas fa-clock" style="font-size: 2.5rem; opacity: 0.9;"></i>
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Solicitudes Pendientes</p>
                            <h3 style="margin: 0.3rem 0 0 0; font-size: 2.2rem; font-weight: 700;" id="dash-solicitudes-pendientes">0</h3>
                        </div>
                    </div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">
                        <i class="fas fa-hourglass-half"></i> Requieren atenci贸n
                    </div>
                </div>

                <!-- Rifas Activas -->
                <div style="background: linear-gradient(135deg, #43e97b, #38f9d7); padding: 1.8rem; border-radius: 15px; box-shadow: 0 8px 25px rgba(67, 233, 123, 0.2); color: white;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <i class="fas fa-ticket-alt" style="font-size: 2.5rem; opacity: 0.9;"></i>
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Rifas Activas</p>
                            <h3 style="margin: 0.3rem 0 0 0; font-size: 2.2rem; font-weight: 700;" id="dash-rifas-activas">0</h3>
                        </div>
                    </div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">
                        <i class="fas fa-money-bill-wave"></i> <span id="dash-rifas-ingresos">$0</span> en boletos
                    </div>
                </div>

                <!-- Productos Activos -->
                <div style="background: linear-gradient(135deg, #fa8bff, #2bd2ff); padding: 1.8rem; border-radius: 15px; box-shadow: 0 8px 25px rgba(250, 139, 255, 0.2); color: white;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <i class="fas fa-shopping-bag" style="font-size: 2.5rem; opacity: 0.9;"></i>
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Productos en Venta</p>
                            <h3 style="margin: 0.3rem 0 0 0; font-size: 2.2rem; font-weight: 700;" id="dash-productos-activos">0</h3>
                        </div>
                    </div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">
                        <i class="fas fa-chart-line"></i> <span id="dash-productos-vendidos">0</span> vendidos
                    </div>
                </div>
            </div>

            <!-- Acciones R谩pidas del Dashboard -->
            <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 2rem;">
                <h3 style="margin: 0 0 1.5rem 0; color: #333; font-size: 1.4rem; font-weight: 700;">
                    <i class="fas fa-bolt" style="color: var(--primary);"></i> Acceso R谩pido
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <button onclick="cambiarTab('cuentas', document.querySelector('[onclick*=\\\'cuentas\\\']'))" style="background: linear-gradient(135deg, #4a90e2, #357abd); color: white; border: none; padding: 1.2rem; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.3s; text-align: left;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-users-cog" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                        Gestionar Cuentas
                    </button>
                    <button onclick="cambiarTab('finanzas', document.querySelector('[onclick*=\\\'finanzas\\\']'))" style="background: linear-gradient(135deg, #50c878, #3da85e); color: white; border: none; padding: 1.2rem; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.3s; text-align: left;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-wallet" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                        Gesti贸n Financiera
                    </button>
                    <button onclick="cambiarTab('subastas', document.querySelector('[onclick*=\\\'subastas\\\']'))" style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; padding: 1.2rem; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.3s; text-align: left;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-gavel" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                        Gestionar Subastas
                    </button>
                    <button onclick="cambiarTab('rifas', document.querySelector('[onclick*=\\\'rifas\\\']'))" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 1.2rem; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.3s; text-align: left;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-ticket-alt" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                        Gestionar Rifas
                    </button>
                    <button onclick="cambiarTab('ventas', document.querySelector('[onclick*=\\\'ventas\\\']'))" style="background: linear-gradient(135deg, #1abc9c, #16a085); color: white; border: none; padding: 1.2rem; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.3s; text-align: left;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-shopping-cart" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                        Gestionar Ventas
                    </button>
                    <button onclick="cambiarTab('solicitudes', document.querySelector('[onclick*=\\\'solicitudes\\\']'))" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; border: none; padding: 1.2rem; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.3s; text-align: left;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-clock" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                        Ver Solicitudes
                    </button>
                    <button onclick="mostrarModalRifas()" style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; border: none; padding: 1.2rem; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.3s; text-align: left;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-ticket-alt" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                        Gestionar Rifas
                    </button>
                    <button onclick="mostrarModalProductos()" style="background: linear-gradient(135deg, #ee0979, #ff6a00); color: white; border: none; padding: 1.2rem; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.3s; text-align: left;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-shopping-bag" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                        Gestionar Productos
                    </button>
                </div>
            </div>

            <!-- Actividad Reciente -->
            <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <h3 style="margin: 0 0 1.5rem 0; color: #333; font-size: 1.4rem; font-weight: 700;">
                    <i class="fas fa-history" style="color: var(--primary);"></i> Actividad Reciente
                </h3>
                <div id="actividad-reciente" style="max-height: 400px; overflow-y: auto;">
                    <!-- Se llena con JavaScript -->
                </div>
            </div>
        </div>

        <!-- Tab: Gesti贸n de Cuentas Unificada -->
        <div id="tab-cuentas" class="tab-content">
            <!-- Filtros y b煤squeda -->
            <div style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" id="buscar-cuenta" placeholder=" Buscar por nombre, RUT, email o username..." style="width: 100%; padding: 0.9rem 1.2rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;" onkeyup="filtrarCuentas()">
                    </div>
                    <select id="filtro-tipo-cuenta" onchange="filtrarCuentas()" style="padding: 0.9rem 1.2rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;">
                        <option value="all">Todos los tipos</option>
                        <option value="user">Solo Usuarios</option>
                        <option value="empresa">Solo Empresas</option>
                        <option value="admin">Solo Admins</option>
                    </select>
                    <select id="filtro-estado-cuenta" onchange="filtrarCuentas()" style="padding: 0.9rem 1.2rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;">
                        <option value="all">Todos los estados</option>
                        <option value="active">Activos</option>
                        <option value="blocked">Bloqueados</option>
                    </select>
                    <button onclick="cargarTodasCuentas()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 0.9rem 1.8rem; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>

            <!-- Tabla unificada de cuentas -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Nombre/Raz贸n Social</th>
                            <th>Username</th>
                            <th>RUT</th>
                            <th>Email</th>
                            <th>Saldo</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-cuentas-unificada">
                        <!-- Se llena con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Solicitudes Pendientes -->
        <div id="tab-solicitudes" class="tab-content">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Raz贸n Social</th>
                            <th>RUT</th>
                            <th>Email</th>
                            <th>Fecha Registro</th>
                            <th>Documentos</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-pendientes">
                        <!-- Se llena con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Restablecimientos de Contrase帽a -->
        <div id="tab-restablecimientos" class="tab-content">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Cuenta</th>
                            <th>Email</th>
                            <th>Fecha Solicitud</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-restablecimientos">
                        <!-- Se llena con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Todas las Empresas -->
        <div id="tab-empresas" class="tab-content">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Raz贸n Social</th>
                            <th>RUT</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-empresas">
                        <!-- Se llena con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Todos los Usuarios -->
        <div id="tab-usuarios" class="tab-content">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Username</th>
                            <th>RUT</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Fecha Registro</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-usuarios">
                        <!-- Se llena con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Gesti贸n Financiera -->
        <div id="tab-finanzas" class="tab-content">
            <!-- Encabezado del Dashboard -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; background: white; padding: 1.5rem 2rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <div>
                    <h2 style="margin: 0 0 0.5rem 0; color: var(--primary); font-size: 2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-chart-line"></i> Dashboard Financiero
                    </h2>
                    <p style="margin: 0; color: #666; font-size: 1rem;">Visi贸n general del sistema financiero</p>
                </div>
                <button onclick="actualizarDashboardFinanciero()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 0.9rem 2rem; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>

            <!-- Tarjetas de Estad铆sticas -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Total en Usuarios -->
                <div style="background: white; padding: 1.8rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid #4a90e2; transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.05)'">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.2rem;">
                        <div style="background: linear-gradient(135deg, #4a90e2, #357abd); width: 55px; height: 55px; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);">
                            <i class="fas fa-users" style="font-size: 1.6rem; color: white;"></i>
                        </div>
                        <span style="background: #e3f2fd; color: #1976d2; padding: 0.4rem 0.9rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                            <i class="fas fa-user"></i> <span id="total-usuarios-count">0</span>
                        </span>
                    </div>
                    <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem; font-weight: 600;">Total en Usuarios</p>
                    <h3 style="margin: 0; color: #4a90e2; font-size: 2rem; font-weight: 700;" id="total-usuarios-saldo">$0</h3>
                </div>

                <!-- Total en Empresas -->
                <div style="background: white; padding: 1.8rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid #50c878; transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.05)'">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.2rem;">
                        <div style="background: linear-gradient(135deg, #50c878, #3da85e); width: 55px; height: 55px; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(80, 200, 120, 0.3);">
                            <i class="fas fa-building" style="font-size: 1.6rem; color: white;"></i>
                        </div>
                        <span style="background: #e8f5e9; color: #2e7d32; padding: 0.4rem 0.9rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                            <i class="fas fa-briefcase"></i> <span id="total-empresas-count">0</span>
                        </span>
                    </div>
                    <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem; font-weight: 600;">Total en Empresas</p>
                    <h3 style="margin: 0; color: #50c878; font-size: 2rem; font-weight: 700;" id="total-empresas-saldo">$0</h3>
                </div>

                <!-- Circulaci贸n Total -->
                <div style="background: white; padding: 1.8rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid #f39c12; transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.05)'">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.2rem;">
                        <div style="background: linear-gradient(135deg, #f39c12, #e67e22); width: 55px; height: 55px; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);">
                            <i class="fas fa-coins" style="font-size: 1.6rem; color: white;"></i>
                        </div>
                        <span style="background: #fff3e0; color: #e65100; padding: 0.4rem 0.9rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                            <i class="fas fa-exchange-alt"></i> <span id="total-transacciones">0</span>
                        </span>
                    </div>
                    <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem; font-weight: 600;">Circulaci贸n Total</p>
                    <h3 style="margin: 0; color: #f39c12; font-size: 2rem; font-weight: 700;" id="total-circulacion">$0</h3>
                </div>

                <!-- En Subastas -->
                <div style="background: white; padding: 1.8rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid #9b59b6; transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.05)'">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.2rem;">
                        <div style="background: linear-gradient(135deg, #9b59b6, #8e44ad); width: 55px; height: 55px; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);">
                            <i class="fas fa-gavel" style="font-size: 1.6rem; color: white;"></i>
                        </div>
                        <span style="background: #f3e5f5; color: #6a1b9a; padding: 0.4rem 0.9rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                            <i class="fas fa-fire"></i> <span id="total-subastas-count">0</span>
                        </span>
                    </div>
                    <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem; font-weight: 600;">En Subastas</p>
                    <h3 style="margin: 0; color: #9b59b6; font-size: 2rem; font-weight: 700;" id="total-subastas-activas">0</h3>
                </div>
            </div>

            <!-- Acciones R谩pidas -->
            <div style="margin-bottom: 2.5rem;">
                <h3 style="margin: 0 0 1.5rem 0; color: #333; font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-bolt" style="color: var(--primary);"></i> Acciones R谩pidas
                </h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                    <!-- Gestionar Usuarios -->
                    <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onclick="abrirModalGestionFinanzas('user')" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(74, 144, 226, 0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.05)'">
                        <div style="background: linear-gradient(135deg, #4a90e2, #357abd); width: 65px; height: 65px; border-radius: 18px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);">
                            <i class="fas fa-users" style="font-size: 2rem; color: white;"></i>
                        </div>
                        <h4 style="margin: 0 0 0.7rem 0; color: #333; font-size: 1.2rem; font-weight: 700;">Gestionar Usuarios</h4>
                        <p style="margin: 0 0 1.5rem 0; color: #666; font-size: 0.95rem; line-height: 1.5;">Modifica y administra los saldos de todos los usuarios del sistema</p>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                            <span style="color: #4a90e2; font-weight: 700; font-size: 0.95rem;">Gestionar <i class="fas fa-arrow-right"></i></span>
                        </div>
                    </div>

                    <!-- Gestionar Empresas -->
                    <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onclick="abrirModalGestionFinanzas('empresa')" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(80, 200, 120, 0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.05)'">
                        <div style="background: linear-gradient(135deg, #50c878, #3da85e); width: 65px; height: 65px; border-radius: 18px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; box-shadow: 0 8px 20px rgba(80, 200, 120, 0.3);">
                            <i class="fas fa-building" style="font-size: 2rem; color: white;"></i>
                        </div>
                        <h4 style="margin: 0 0 0.7rem 0; color: #333; font-size: 1.2rem; font-weight: 700;">Gestionar Empresas</h4>
                        <p style="margin: 0 0 1.5rem 0; color: #666; font-size: 0.95rem; line-height: 1.5;">Modifica y administra los saldos de todas las empresas del sistema</p>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                            <span style="color: #50c878; font-weight: 700; font-size: 0.95rem;">Gestionar <i class="fas fa-arrow-right"></i></span>
                        </div>
                    </div>

                    <!-- Registro de Auditor铆a -->
                    <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;" onclick="mostrarAuditoria()" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(155, 89, 182, 0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.05)'">
                        <div style="background: linear-gradient(135deg, #9b59b6, #8e44ad); width: 65px; height: 65px; border-radius: 18px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; box-shadow: 0 8px 20px rgba(155, 89, 182, 0.3);">
                            <i class="fas fa-file-alt" style="font-size: 2rem; color: white;"></i>
                        </div>
                        <h4 style="margin: 0 0 0.7rem 0; color: #333; font-size: 1.2rem; font-weight: 700;">Registro de Auditor铆a</h4>
                        <p style="margin: 0 0 1.5rem 0; color: #666; font-size: 0.95rem; line-height: 1.5;">Consulta el historial completo de todos los movimientos del sistema</p>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                            <span style="color: #9b59b6; font-weight: 700; font-size: 0.95rem;">Ver Auditor铆a <i class="fas fa-arrow-right"></i></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registro de Auditor铆a -->
            <div class="admin-card" id="auditoria-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary); margin: 0;">
                        <i class="fas fa-clipboard-list"></i> Registro de Auditor铆a
                    </h3>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="filtro-tipo-auditoria" onchange="filtrarAuditoria()" style="padding: 0.6rem 1rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                            <option value="all">Todos los eventos</option>
                            <option value="transaction">Transacciones</option>
                            <option value="user_action">Acciones de usuario</option>
                            <option value="admin_action">Acciones de admin</option>
                            <option value="auction">Subastas</option>
                            <option value="security">Seguridad</option>
                        </select>
                        <button onclick="exportarAuditoria()" style="background: #27ae60; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <button onclick="ocultarAuditoria()" style="background: #e74c3c; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; text-align: center;">
                        <div>
                            <p style="margin: 0; color: #666; font-size: 0.85rem;">Total de Eventos</p>
                            <p style="margin: 0.3rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: var(--primary);" id="total-eventos-audit">0</p>
                        </div>
                        <div>
                            <p style="margin: 0; color: #666; font-size: 0.85rem;">ltimas 24 horas</p>
                            <p style="margin: 0.3rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: #27ae60;" id="eventos-24h">0</p>
                        </div>
                        <div>
                            <p style="margin: 0; color: #666; font-size: 0.85rem;">Esta Semana</p>
                            <p style="margin: 0.3rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: #f39c12;" id="eventos-semana">0</p>
                        </div>
                        <div>
                            <p style="margin: 0; color: #666; font-size: 0.85rem;">Este Mes</p>
                            <p style="margin: 0.3rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: #9b59b6;" id="eventos-mes">0</p>
                        </div>
                    </div>
                </div>

                <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                    <table class="data-table">
                        <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                            <tr>
                                <th style="width: 140px;">Fecha/Hora</th>
                                <th style="width: 120px;">Tipo</th>
                                <th style="width: 150px;">Usuario/Entidad</th>
                                <th>Descripci贸n</th>
                                <th style="width: 120px;">Monto</th>
                                <th style="width: 100px;">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-auditoria">
                            <!-- Se llena con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Gesti贸n de Subastas -->
        <div id="tab-subastas" class="tab-content">
            <!-- Filtros -->
            <div style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" id="buscar-subasta" placeholder=" Buscar subasta..." style="width: 100%; padding: 0.9rem 1.2rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;" onkeyup="filtrarSubastas()">
                    </div>
                    <select id="filtro-estado-subasta" onchange="filtrarSubastas()" style="padding: 0.9rem 1.2rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;">
                        <option value="all">Todos los estados</option>
                        <option value="activa">Activas</option>
                        <option value="finalizada">Finalizadas</option>
                        <option value="cancelada">Canceladas</option>
                    </select>
                    <button onclick="cargarTodasSubastas()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 0.9rem 1.8rem; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>

            <!-- Tabla de subastas -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>T铆tulo</th>
                            <th>Empresa</th>
                            <th>Tipo</th>
                            <th>Precio Actual</th>
                            <th>Pujas</th>
                            <th>Estado</th>
                            <th>Fecha Fin</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-subastas-admin">
                        <!-- Se llena con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Gesti贸n de Rifas -->
        <div id="tab-rifas" class="tab-content">
            <!-- Filtros -->
            <div style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" id="buscar-rifa" placeholder=" Buscar rifa..." style="width: 100%; padding: 0.9rem 1.2rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;" onkeyup="filtrarRifasAdmin()">
                    </div>
                    <select id="filtro-estado-rifa" onchange="filtrarRifasAdmin()" style="padding: 0.9rem 1.2rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;">
                        <option value="all">Todos los estados</option>
                        <option value="activa">Activas</option>
                        <option value="proxima">Pr贸ximas</option>
                        <option value="finalizada">Finalizadas</option>
                        <option value="cancelada">Canceladas</option>
                    </select>
                    <button onclick="cargarTodasRifas()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 0.9rem 1.8rem; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>

            <!-- Tabla de rifas -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>T铆tulo</th>
                            <th>Empresa</th>
                            <th>Precio Boleto</th>
                            <th>Total Boletos</th>
                            <th>Vendidos</th>
                            <th>Recaudado</th>
                            <th>Estado</th>
                            <th>Fecha Sorteo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-rifas-admin">
                        <!-- Se llena con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Gesti贸n de Ventas -->
        <div id="tab-ventas" class="tab-content">
            <!-- Filtros -->
            <div style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" id="buscar-producto" placeholder=" Buscar producto..." style="width: 100%; padding: 0.9rem 1.2rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;" onkeyup="filtrarProductosAdmin()">
                    </div>
                    <select id="filtro-categoria-producto" onchange="filtrarProductosAdmin()" style="padding: 0.9rem 1.2rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;">
                        <option value="all">Todas las categor铆as</option>
                        <option value="Electr贸nica">Electr贸nica</option>
                        <option value="Ropa">Ropa</option>
                        <option value="Hogar">Hogar</option>
                        <option value="Alimentos">Alimentos</option>
                        <option value="Libros">Libros</option>
                        <option value="Artesan铆as">Artesan铆as</option>
                        <option value="Otros">Otros</option>
                    </select>
                    <button onclick="cargarTodosProductos()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 0.9rem 1.8rem; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>

            <!-- Tabla de productos -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Empresa</th>
                            <th>Categor铆a</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Vendidos</th>
                            <th>Recaudado</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-productos-admin">
                        <!-- Se llena con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Sistema -->
        <div id="tab-sistema" class="tab-content">
            <!-- Informaci贸n del Sistema -->
            <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 1.5rem;">
                <h3 style="margin: 0 0 1.5rem 0; color: #333; font-size: 1.4rem; font-weight: 700;">
                    <i class="fas fa-server" style="color: var(--primary);"></i> Informaci贸n del Sistema
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                        <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem;">Versi贸n del Sistema</p>
                        <p style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--primary);">NEXOS v2.0</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                        <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem;">Base de Datos</p>
                        <p style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--primary);">LocalStorage</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                        <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem;">Espacio Usado</p>
                        <p style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--primary);" id="espacio-usado">0 KB</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                        <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem;">Total de Registros</p>
                        <p style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--primary);" id="total-registros">0</p>
                    </div>
                </div>
            </div>

            <!-- Gesti贸n de Datos -->
            <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 1.5rem;">
                <h3 style="margin: 0 0 1.5rem 0; color: #333; font-size: 1.4rem; font-weight: 700;">
                    <i class="fas fa-database" style="color: var(--primary);"></i> Gesti贸n de Datos
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button onclick="exportarDatos()" style="background: #27ae60; color: white; border: none; padding: 1rem; border-radius: 10px; cursor: pointer; font-weight: 600; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-download" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                        Exportar Datos
                    </button>
                    <button onclick="limpiarCache()" style="background: #f39c12; color: white; border: none; padding: 1rem; border-radius: 10px; cursor: pointer; font-weight: 600; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-broom" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                        Limpiar Cach茅
                    </button>
                    <button onclick="reiniciarSistema()" style="background: #e74c3c; color: white; border: none; padding: 1rem; border-radius: 10px; cursor: pointer; font-weight: 600; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-redo" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                        Reiniciar Sistema
                    </button>
                    <button onclick="generarReporte()" style="background: #9b59b6; color: white; border: none; padding: 1rem; border-radius: 10px; cursor: pointer; font-weight: 600; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
                        <i class="fas fa-file-pdf" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                        Generar Reporte
                    </button>
                </div>
            </div>

            <!-- Logs del Sistema -->
            <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <h3 style="margin: 0 0 1.5rem 0; color: #333; font-size: 1.4rem; font-weight: 700;">
                    <i class="fas fa-list-alt" style="color: var(--primary);"></i> Logs del Sistema
                </h3>
                <div style="background: #1e1e1e; color: #00ff00; padding: 1.5rem; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 0.9rem; max-height: 400px; overflow-y: auto;" id="system-logs">
                    <p style="margin: 0;">[INFO] Sistema iniciado correctamente</p>
                    <p style="margin: 0;">[INFO] Base de datos cargada</p>
                    <p style="margin: 0;">[INFO] Administrador autenticado</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalles -->
    <div id="modal-detalles" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-info-circle"></i> Detalles de la Cuenta</h2>
                <button class="btn-close" onclick="cerrarModal()">&times;</button>
            </div>
            <div id="modal-body">
                <!-- Se llena con JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal de Cambio de Contrase帽a -->
    <div id="modal-password" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-key"></i> Cambiar Contrase帽a</h2>
                <button class="btn-close" onclick="cerrarModalPassword()">&times;</button>
            </div>
            <div id="modal-password-body">
                <p style="margin-bottom: 1.5rem; color: #666;">
                    <strong id="password-cuenta-nombre"></strong>
                </p>
                <form id="form-cambiar-password" onsubmit="cambiarPassword(event)">
                    <div style="margin-bottom: 1rem;">
                        <label for="nueva-password" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Nueva Contrase帽a:
                        </label>
                        <input 
                            type="password" 
                            id="nueva-password" 
                            name="nueva-password"
                            required
                            minlength="4"
                            style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"
                            placeholder="M铆nimo 4 caracteres"
                        >
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label for="confirmar-password" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Confirmar Contrase帽a:
                        </label>
                        <input 
                            type="password" 
                            id="confirmar-password" 
                            name="confirmar-password"
                            required
                            minlength="4"
                            style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"
                            placeholder="Repetir contrase帽a"
                        >
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn-action btn-delete" onclick="cerrarModalPassword()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn-action btn-approve">
                            <i class="fas fa-check"></i> Cambiar Contrase帽a
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Aprobar Restablecimiento -->
    <div id="modal-aprobar-reset" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-check-circle"></i> Aprobar Restablecimiento</h2>
                <button class="btn-close" onclick="cerrarModalAprobarReset()">&times;</button>
            </div>
            <div style="padding: 2rem;">
                <p style="margin-bottom: 1.5rem; color: #666;">
                    <strong id="reset-cuenta-info"></strong>
                </p>
                <form id="form-aprobar-reset" onsubmit="confirmarAprobarReset(event)">
                    <div style="margin-bottom: 1rem;">
                        <label for="nueva-password-reset" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Nueva Contrase帽a:
                        </label>
                        <input 
                            type="password" 
                            id="nueva-password-reset" 
                            name="nueva-password-reset"
                            required
                            minlength="4"
                            style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"
                            placeholder="M铆nimo 4 caracteres"
                        >
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label for="confirmar-password-reset" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Confirmar Contrase帽a:
                        </label>
                        <input 
                            type="password" 
                            id="confirmar-password-reset" 
                            name="confirmar-password-reset"
                            required
                            minlength="4"
                            style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"
                            placeholder="Repetir contrase帽a"
                        >
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn-action btn-delete" onclick="cerrarModalAprobarReset()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn-action btn-approve">
                            <i class="fas fa-check"></i> Aprobar y Establecer Contrase帽a
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Rechazar Restablecimiento -->
    <div id="modal-rechazar-reset" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-times-circle"></i> Rechazar Restablecimiento</h2>
                <button class="btn-close" onclick="cerrarModalRechazarReset()">&times;</button>
            </div>
            <div style="padding: 2rem;">
                <p style="margin-bottom: 1.5rem; color: #666;">
                    <strong id="reset-cuenta-info-rechazar"></strong>
                </p>
                <form id="form-rechazar-reset" onsubmit="confirmarRechazarReset(event)">
                    <div style="margin-bottom: 1.5rem;">
                        <label for="motivo-rechazo-reset" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Motivo del Rechazo (opcional):
                        </label>
                        <textarea 
                            id="motivo-rechazo-reset" 
                            name="motivo-rechazo-reset"
                            rows="3"
                            style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; resize: vertical;"
                            placeholder="Explica el motivo del rechazo..."
                        ></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn-action btn-view" onclick="cerrarModalRechazarReset()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn-action btn-reject">
                            <i class="fas fa-ban"></i> Confirmar Rechazo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Gesti贸n Financiera -->
    <div id="modal-gestion-finanzas" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-wallet"></i> Gesti贸n Financiera - <span id="tipo-cuentas-titulo">Usuarios</span></h2>
                <button class="btn-close" onclick="cerrarModalGestionFinanzas()">&times;</button>
            </div>
            <div id="modal-gestion-finanzas-body" style="padding: 2rem;">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre/Raz贸n Social</th>
                                <th>Email</th>
                                <th>Saldo Actual</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-cuentas-finanzas">
                            <!-- Se llena con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Modificar Saldo -->
    <div id="modal-modificar-saldo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Modificar Saldo</h2>
                <button class="btn-close" onclick="cerrarModalModificarSaldo()">&times;</button>
            </div>
            <div style="padding: 2rem;">
                <p style="margin-bottom: 1.5rem; color: #666;">
                    <strong id="saldo-cuenta-nombre"></strong>
                </p>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">Saldo Actual</p>
                    <h3 style="margin: 0.5rem 0 0 0; color: var(--primary); font-size: 1.8rem;" id="saldo-actual-display">$0</h3>
                </div>
                <form id="form-modificar-saldo" onsubmit="modificarSaldoCuenta(event)">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Tipo de Operaci贸n:
                        </label>
                        <select 
                            id="tipo-operacion" 
                            name="tipo-operacion"
                            required
                            style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"
                        >
                            <option value="ingreso">Agregar Saldo (+)</option>
                            <option value="egreso">Retirar Saldo (-)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Monto:
                        </label>
                        <input 
                            type="number" 
                            id="monto-operacion" 
                            name="monto-operacion"
                            required
                            min="1000"
                            step="1000"
                            style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"
                            placeholder="Ej: 100000"
                        >
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                            Motivo/Descripci贸n:
                        </label>
                        <input 
                            type="text" 
                            id="motivo-operacion" 
                            name="motivo-operacion"
                            required
                            style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"
                            placeholder="Ej: Ajuste por pruebas del sistema"
                        >
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn-secondary" onclick="cerrarModalModificarSaldo()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-check"></i> Modificar Saldo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 Nexos. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script src="notifications.js"></script>
    <script src="auth.js"></script>
    <script src="config.js"></script>
    <script>
        // Verificar que sea admin
        if (!auth.isLoggedIn()) {
            window.location.href = 'login.html';
        }

        const session = auth.getSession();
        if (session.role !== 'admin') {
            notify.error('Acceso denegado. Solo administradores pueden acceder a esta p谩gina.');
            setTimeout(() => window.location.href = 'index.html', 2000);
        }

        // ===== VARIABLES GLOBALES PARA GESTIN FINANCIERA =====
        let tipoCuentasActual = 'user';
        let cuentaSeleccionada = null;

        // Cargar datos iniciales
        cargarEstadisticas();
        cargarDashboardPrincipal();
        cargarPendientes();
        cargarRestablecimientos();
        cargarEmpresas();
        cargarUsuarios();
        cargarRechazadas();
        calcularEspacioUsado();

        function cargarEstadisticas() {
            const pendientes = auth.getEmpresasPendientes();
            const empresas = auth.getEmpresas();
            const rechazadas = auth.getEmpresasRechazadas();
            const usuarios = auth.getUsers();

            document.getElementById('stat-pending').textContent = pendientes.length;
            document.getElementById('stat-approved').textContent = empresas.filter(function(e) { return e.estado === 'aprobada'; }).length;
            document.getElementById('stat-rejected').textContent = rechazadas.length;
            document.getElementById('stat-users').textContent = usuarios.length;
        }

        function cambiarTab(tab, element) {
            // Ocultar todos los tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(function(t) { t.classList.remove('active'); });

            const buttons = document.querySelectorAll('.admin-tab');
            buttons.forEach(function(b) { b.classList.remove('active'); });

            // Mostrar tab seleccionado
            document.getElementById('tab-' + tab).classList.add('active');
            
            // Activar bot贸n correspondiente
            const targetButton = element || document.querySelector('[onclick*="' + tab + '"]');
            if (targetButton) {
                targetButton.classList.add('active');
            }

            // Cargar datos espec铆ficos seg煤n el tab
            if (tab === 'dashboard') {
                cargarDashboardPrincipal();
            } else if (tab === 'cuentas') {
                cargarTodasCuentas();
            } else if (tab === 'subastas') {
                cargarTodasSubastas();
            }
        }

        // Funci贸n para cargar el dashboard principal
        function cargarDashboardPrincipal() {
            const usuarios = auth.getUsers();
            const empresas = auth.getEmpresas();
            const subastas = JSON.parse(localStorage.getItem('nexos_subastas') || '[]');
            const pendientes = auth.getEmpresasPendientes();

            // Estad铆sticas generales
            const totalCuentas = usuarios.length + empresas.length;
            const totalUsers = usuarios.length;
            const totalEmpresas = empresas.length;
            
            document.getElementById('dash-total-cuentas').textContent = totalCuentas;
            document.getElementById('dash-total-users').textContent = totalUsers;
            document.getElementById('dash-total-empresas').textContent = totalEmpresas;

            // Circulaci贸n total
            const circulacionUsers = usuarios.reduce((sum, u) => sum + (u.saldo || 0), 0);
            const circulacionEmpresas = empresas.reduce((sum, e) => sum + (e.saldo || 0), 0);
            const circulacionTotal = circulacionUsers + circulacionEmpresas;
            
            document.getElementById('dash-circulacion-total').textContent = '$' + circulacionTotal.toLocaleString('es-CL');
            
            const totalTransacciones = usuarios.reduce((sum, u) => sum + (u.transacciones || []).length, 0) +
                                      empresas.reduce((sum, e) => sum + (e.transacciones || []).length, 0);
            document.getElementById('dash-total-transacciones').textContent = totalTransacciones;

            // Subastas activas
            const subastasActivas = subastas.filter(s => s.estado === 'activa').length;
            document.getElementById('dash-subastas-activas').textContent = subastasActivas;

            // Solicitudes pendientes
            document.getElementById('dash-solicitudes-pendientes').textContent = pendientes.length;

            // Rifas activas
            const rifas = JSON.parse(localStorage.getItem('nexos_rifas') || '[]');
            const rifasActivas = rifas.filter(r => r.estado === 'activa').length;
            document.getElementById('dash-rifas-activas').textContent = rifasActivas;
            
            // Calcular ingresos totales de rifas (boletos vendidos)
            const ingresosRifas = rifas.reduce((total, rifa) => {
                const boletosVendidos = rifa.boletos ? rifa.boletos.filter(b => b.comprado).length : 0;
                return total + (boletosVendidos * rifa.precioBoleto);
            }, 0);
            document.getElementById('dash-rifas-ingresos').textContent = '$' + ingresosRifas.toLocaleString('es-CL');

            // Productos activos
            const productos = JSON.parse(localStorage.getItem('nexos_productos') || '[]');
            const productosActivos = productos.filter(p => p.stock > 0).length;
            document.getElementById('dash-productos-activos').textContent = productosActivos;
            
            // Total de productos vendidos
            const productosVendidos = productos.reduce((total, prod) => {
                const ventas = prod.ventas || [];
                return total + ventas.reduce((sum, v) => sum + v.cantidad, 0);
            }, 0);
            document.getElementById('dash-productos-vendidos').textContent = productosVendidos;

            // Cargar actividad reciente
            cargarActividadReciente();
        }

        // Funci贸n para cargar actividad reciente
        function cargarActividadReciente() {
            const actividadDiv = document.getElementById('actividad-reciente');
            const usuarios = auth.getUsers();
            const empresas = auth.getEmpresas();
            const subastas = JSON.parse(localStorage.getItem('nexos_subastas') || '[]');

            let actividades = [];

            // Obtener actividades de usuarios
            usuarios.forEach(user => {
                if (user.actividadReciente && user.actividadReciente.length > 0) {
                    user.actividadReciente.slice(-5).forEach(act => {
                        actividades.push({
                            tipo: 'user',
                            usuario: user.username || user.nombre,
                            accion: act.tipo,
                            detalle: act.descripcion,
                            fecha: new Date(act.fecha)
                        });
                    });
                }
            });

            // Obtener actividades de empresas
            empresas.forEach(empresa => {
                if (empresa.actividadReciente && empresa.actividadReciente.length > 0) {
                    empresa.actividadReciente.slice(-5).forEach(act => {
                        actividades.push({
                            tipo: 'empresa',
                            usuario: empresa.nombreEmpresa || empresa.razonSocial,
                            accion: act.tipo,
                            detalle: act.descripcion,
                            fecha: new Date(act.fecha)
                        });
                    });
                }
            });

            // Ordenar por fecha descendente
            actividades.sort((a, b) => b.fecha - a.fecha);
            actividades = actividades.slice(0, 15); // Solo las 煤ltimas 15

            if (actividades.length === 0) {
                actividadDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No hay actividad reciente</p>';
                return;
            }

            actividadDiv.innerHTML = actividades.map(act => {
                const iconoTipo = act.tipo === 'user' ? 'fa-user' : 'fa-building';
                const colorTipo = act.tipo === 'user' ? '#4a90e2' : '#50c878';
                const fechaRelativa = obtenerFechaRelativa(act.fecha);

                return `
                    <div style="display: flex; align-items: start; gap: 1rem; padding: 1rem; border-bottom: 1px solid #f0f0f0;">
                        <div style="background: ${colorTipo}; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas ${iconoTipo}" style="color: white;"></i>
                        </div>
                        <div style="flex: 1;">
                            <p style="margin: 0 0 0.3rem 0; font-weight: 600; color: #333;">${act.usuario}</p>
                            <p style="margin: 0 0 0.3rem 0; color: #666; font-size: 0.95rem;">${act.detalle}</p>
                            <p style="margin: 0; color: #999; font-size: 0.85rem;">
                                <i class="fas fa-clock"></i> ${fechaRelativa}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Funci贸n auxiliar para obtener fecha relativa
        function obtenerFechaRelativa(fecha) {
            const ahora = new Date();
            const diff = ahora - fecha;
            const minutos = Math.floor(diff / 60000);
            const horas = Math.floor(diff / 3600000);
            const dias = Math.floor(diff / 86400000);

            if (minutos < 1) return 'Hace un momento';
            if (minutos < 60) return `Hace ${minutos} minuto${minutos > 1 ? 's' : ''}`;
            if (horas < 24) return `Hace ${horas} hora${horas > 1 ? 's' : ''}`;
            if (dias < 7) return `Hace ${dias} d铆a${dias > 1 ? 's' : ''}`;
            return fecha.toLocaleDateString('es-CL');
        }

        // Funci贸n para cargar todas las cuentas (usuarios y empresas unificadas)
        function cargarTodasCuentas() {
            const usuarios = auth.getUsers();
            const empresas = auth.getEmpresas();
            const tbody = document.getElementById('tabla-cuentas-unificada');

            let cuentas = [];
            let adminAgregado = false;

            // Agregar usuarios (solo un admin)
            usuarios.forEach(user => {
                // Solo agregar un admin (el primero que encuentre)
                if (user.role === 'admin' && adminAgregado) {
                    return; // Skip admin duplicados
                }
                
                if (user.role === 'admin') {
                    adminAgregado = true;
                }

                cuentas.push({
                    tipo: 'user',
                    tipoLabel: 'Usuario',
                    nombre: user.nombre + ' ' + (user.apellido || ''),
                    username: user.username,
                    rut: user.rut || 'N/A',
                    email: user.email,
                    saldo: user.saldo || 0,
                    rol: user.role || 'user',
                    estado: user.bloqueado ? 'blocked' : 'active',
                    id: user.id,
                    data: user
                });
            });

            // Agregar empresas
            empresas.forEach(empresa => {
                cuentas.push({
                    tipo: 'empresa',
                    tipoLabel: 'Empresa',
                    nombre: empresa.nombreEmpresa || empresa.razonSocial,
                    username: empresa.username,
                    rut: empresa.rut || 'N/A',
                    email: empresa.email,
                    saldo: empresa.saldo || 0,
                    rol: empresa.role || 'empresa',
                    estado: empresa.bloqueado ? 'blocked' : 'active',
                    id: empresa.id,
                    data: empresa
                });
            });

            // Ordenar: Admin primero, luego usuarios, luego empresas
            cuentas.sort((a, b) => {
                if (a.rol === 'admin') return -1;
                if (b.rol === 'admin') return 1;
                if (a.tipo === 'user' && b.tipo === 'empresa') return -1;
                if (a.tipo === 'empresa' && b.tipo === 'user') return 1;
                return a.nombre.localeCompare(b.nombre);
            });

            if (cuentas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay cuentas registradas</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = cuentas.map(cuenta => {
                const colorTipo = cuenta.tipo === 'user' ? '#4a90e2' : '#50c878';
                const iconoTipo = cuenta.tipo === 'user' ? 'fa-user' : 'fa-building';
                const badgeEstado = cuenta.estado === 'active' 
                    ? '<span style="background: #d4edda; color: #155724; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">Activo</span>'
                    : '<span style="background: #f8d7da; color: #721c24; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">Bloqueado</span>';

                return `
                    <tr>
                        <td>
                            <span style="background: ${colorTipo}; color: white; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                                <i class="fas ${iconoTipo}"></i> ${cuenta.tipoLabel}
                            </span>
                        </td>
                        <td style="font-weight: 600;">${cuenta.nombre}</td>
                        <td><code>${cuenta.username}</code></td>
                        <td>${cuenta.rut}</td>
                        <td>${cuenta.email}</td>
                        <td style="font-weight: 700; color: #27ae60;">$${cuenta.saldo.toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: ${cuenta.rol === 'admin' ? '#e74c3c' : '#95a5a6'}; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">
                                ${cuenta.rol.toUpperCase()}
                            </span>
                        </td>
                        <td>${badgeEstado}</td>
                        <td>
                            <div class="action-buttons" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn-action btn-view" onclick="verDetalleCuenta('${cuenta.id}', '${cuenta.tipo}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action btn-edit" onclick="editarSaldo('${cuenta.id}', '${cuenta.tipo}')" title="Editar saldo">
                                    <i class="fas fa-dollar-sign"></i>
                                </button>
                                ${cuenta.rol !== 'admin' ? `
                                <button class="btn-action ${cuenta.estado === 'active' ? 'btn-reject' : 'btn-approve'}" onclick="toggleBloquearCuenta('${cuenta.id}', '${cuenta.tipo}', ${cuenta.estado === 'active'})" title="${cuenta.estado === 'active' ? 'Bloquear' : 'Activar'} cuenta">
                                    <i class="fas fa-${cuenta.estado === 'active' ? 'ban' : 'check'}"></i>
                                </button>
                                <button class="btn-action" style="background: #e74c3c; color: white;" onclick="eliminarCuenta('${cuenta.id}', '${cuenta.tipo}', '${cuenta.nombre}')" title="Eliminar cuenta">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Guardar las cuentas para filtrado
            window.todasLasCuentas = cuentas;
        }

        // Funci贸n para filtrar cuentas
        function filtrarCuentas() {
            const busqueda = document.getElementById('buscar-cuenta').value.toLowerCase();
            const tipoFiltro = document.getElementById('filtro-tipo-cuenta').value;
            const estadoFiltro = document.getElementById('filtro-estado-cuenta').value;

            if (!window.todasLasCuentas) {
                cargarTodasCuentas();
                return;
            }

            let cuentasFiltradas = window.todasLasCuentas.filter(cuenta => {
                const matchBusqueda = !busqueda || 
                    cuenta.nombre.toLowerCase().includes(busqueda) ||
                    cuenta.username.toLowerCase().includes(busqueda) ||
                    cuenta.rut.toLowerCase().includes(busqueda) ||
                    cuenta.email.toLowerCase().includes(busqueda);

                const matchTipo = tipoFiltro === 'all' || cuenta.tipo === tipoFiltro || 
                                 (tipoFiltro === 'admin' && cuenta.rol === 'admin');

                const matchEstado = estadoFiltro === 'all' || cuenta.estado === estadoFiltro;

                return matchBusqueda && matchTipo && matchEstado;
            });

            const tbody = document.getElementById('tabla-cuentas-unificada');

            if (cuentasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><i class="fas fa-search"></i><p>No se encontraron cuentas con los filtros aplicados</p></div></td></tr>';
                return;
            }

            // Reutilizar el c贸digo de renderizado
            tbody.innerHTML = cuentasFiltradas.map(cuenta => {
                const colorTipo = cuenta.tipo === 'user' ? '#4a90e2' : '#50c878';
                const iconoTipo = cuenta.tipo === 'user' ? 'fa-user' : 'fa-building';
                const badgeEstado = cuenta.estado === 'active' 
                    ? '<span style="background: #d4edda; color: #155724; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">Activo</span>'
                    : '<span style="background: #f8d7da; color: #721c24; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">Bloqueado</span>';

                return `
                    <tr>
                        <td>
                            <span style="background: ${colorTipo}; color: white; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                                <i class="fas ${iconoTipo}"></i> ${cuenta.tipoLabel}
                            </span>
                        </td>
                        <td style="font-weight: 600;">${cuenta.nombre}</td>
                        <td><code>${cuenta.username}</code></td>
                        <td>${cuenta.rut}</td>
                        <td>${cuenta.email}</td>
                        <td style="font-weight: 700; color: #27ae60;">$${cuenta.saldo.toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: ${cuenta.rol === 'admin' ? '#e74c3c' : '#95a5a6'}; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">
                                ${cuenta.rol.toUpperCase()}
                            </span>
                        </td>
                        <td>${badgeEstado}</td>
                        <td>
                            <div class="action-buttons" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn-action btn-view" onclick="verDetalleCuenta('${cuenta.id}', '${cuenta.tipo}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action btn-edit" onclick="editarSaldo('${cuenta.id}', '${cuenta.tipo}')" title="Editar saldo">
                                    <i class="fas fa-dollar-sign"></i>
                                </button>
                                ${cuenta.rol !== 'admin' ? `
                                <button class="btn-action ${cuenta.estado === 'active' ? 'btn-reject' : 'btn-approve'}" onclick="toggleBloquearCuenta('${cuenta.id}', '${cuenta.tipo}', ${cuenta.estado === 'active'})" title="${cuenta.estado === 'active' ? 'Bloquear' : 'Activar'} cuenta">
                                    <i class="fas fa-${cuenta.estado === 'active' ? 'ban' : 'check'}"></i>
                                </button>
                                <button class="btn-action" style="background: #e74c3c; color: white;" onclick="eliminarCuenta('${cuenta.id}', '${cuenta.tipo}', '${cuenta.nombre}')" title="Eliminar cuenta">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Funci贸n para eliminar cuenta
        async function eliminarCuenta(id, tipo, nombre) {
            // Mensajes diferenciados seg煤n el tipo
            let mensajeConfirmacion = '';
            let tituloConfirmacion = '';
            
            console.log('Eliminar cuenta - ID:', id, 'Tipo:', tipo, 'Nombre:', nombre);
            
            if (tipo === 'user' || tipo === 'usuario') {
                mensajeConfirmacion = `驴Est谩s seguro de que deseas eliminar al usuario "${nombre}"?\n\nTambi茅n se eliminar谩n:\n- Todas sus transacciones\n- Su historial de pujas\n- Sus datos personales\n\nEsta acci贸n no se puede deshacer.`;
                tituloConfirmacion = 'Eliminar Usuario';
            } else if (tipo === 'empresa') {
                mensajeConfirmacion = `驴Est谩s seguro de que deseas eliminar esta empresa?\n\n"${nombre}"\n\nTambi茅n se eliminar谩n todas sus subastas. Esta acci贸n no se puede deshacer.`;
                tituloConfirmacion = 'Eliminar Empresa';
            } else {
                console.error('Tipo de cuenta no reconocido:', tipo);
                await notify.error('Tipo de cuenta no v谩lido');
                return;
            }

            const confirmado = await notify.confirm(
                mensajeConfirmacion,
                tituloConfirmacion
            );

            if (!confirmado) return;

            // Determinar si es usuario o empresa
            const esUsuario = (tipo === 'user' || tipo === 'usuario');
            
            if (esUsuario) {
                const usuarios = auth.getUsers();
                const usuarioEliminado = usuarios.find(u => u.id === id);
                const usuariosFiltrados = usuarios.filter(u => u.id !== id);
                localStorage.setItem('nexos_users', JSON.stringify(usuariosFiltrados));

                // Registrar en auditor铆a si existe el sistema
                if (usuarioEliminado && usuarioEliminado.actividadReciente) {
                    const actividad = {
                        tipo: 'admin_action',
                        descripcion: `Cuenta de usuario "${nombre}" eliminada por administrador`,
                        fecha: new Date().toISOString()
                    };
                    // Agregar a logs
                    agregarLog(`[DELETE] Usuario "${nombre}" eliminado del sistema`);
                }

                // Actualizar referencias en subastas
                const subastas = JSON.parse(localStorage.getItem('nexos_subastas') || '[]');
                subastas.forEach(subasta => {
                    if (subasta.pujas) {
                        subasta.pujas = subasta.pujas.filter(puja => puja.userId !== id);
                    }
                });
                localStorage.setItem('nexos_subastas', JSON.stringify(subastas));

                notify.success(`Usuario "${nombre}" eliminado exitosamente`);
                
            } else if (tipo === 'empresa') {
                const empresas = auth.getEmpresas();
                const empresaEliminada = empresas.find(e => e.id === id);
                
                if (!empresaEliminada) {
                    await notify.error('Empresa no encontrada');
                    return;
                }
                
                const empresasFiltradas = empresas.filter(e => e.id !== id);
                localStorage.setItem('nexos_empresas', JSON.stringify(empresasFiltradas));

                // Registrar en auditor铆a
                agregarLog(`[DELETE] Empresa "${nombre}" eliminada del sistema`);

                // Actualizar subastas de la empresa (marcarlas como canceladas)
                const subastas = JSON.parse(localStorage.getItem('nexos_subastas') || '[]');
                subastas.forEach(subasta => {
                    if (subasta.empresaId === id) {
                        subasta.estado = 'cancelada';
                        subasta.motivoCancelacion = 'Empresa eliminada del sistema';
                    }
                });
                localStorage.setItem('nexos_subastas', JSON.stringify(subastas));
                
                notify.success(`Empresa "${nombre}" eliminada exitosamente`);
            }

            cargarTodasCuentas();
            cargarDashboardPrincipal(); // Actualizar estad铆sticas
        }

        // Funci贸n para bloquear/desbloquear cuenta
        async function toggleBloquearCuenta(id, tipo, bloquear) {
            const accion = bloquear ? 'bloquear' : 'activar';
            const confirmado = await notify.confirm(
                `驴Est谩s seguro de ${accion} esta cuenta?`,
                `${bloquear ? 'Bloquear' : 'Activar'} Cuenta`
            );

            if (!confirmado) return;

            if (tipo === 'user') {
                const usuarios = auth.getUsers();
                const index = usuarios.findIndex(u => u.id === id);
                if (index !== -1) {
                    usuarios[index].bloqueado = bloquear;
                    localStorage.setItem('nexos_users', JSON.stringify(usuarios));
                }
            } else {
                const empresas = auth.getEmpresas();
                const index = empresas.findIndex(e => e.id === id);
                if (index !== -1) {
                    empresas[index].bloqueado = bloquear;
                    localStorage.setItem('nexos_empresas', JSON.stringify(empresas));
                }
            }

            notify.success(`Cuenta ${bloquear ? 'bloqueada' : 'activada'} exitosamente`);
            cargarTodasCuentas();
        }

        // Funci贸n para ver detalle de cuenta (reutiliza la modal existente)
        function verDetalleCuenta(id, tipo) {
            // Convertir 'user' a 'usuario' para que verDetalles lo entienda
            const tipoCorregido = tipo === 'user' ? 'usuario' : tipo;
            verDetalles(id, tipoCorregido);
        }

        // Funci贸n para editar saldo de una cuenta espec铆fica
        function editarSaldo(id, tipo) {
            const esUsuario = (tipo === 'user' || tipo === 'usuario');
            let cuenta = null;
            
            if (esUsuario) {
                cuenta = auth.getUsers().find(u => u.id === id);
            } else {
                cuenta = auth.getEmpresas().find(e => e.id === id);
            }
            
            if (!cuenta) {
                notify.error('Cuenta no encontrada');
                return;
            }
            
            abrirModalEdicionSaldo(cuenta, esUsuario);
        }
        
        // Modal de edici贸n individual de saldo
        function abrirModalEdicionSaldo(cuenta, esUsuario) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--primary);">
                        <h2 style="margin: 0; color: var(--primary);">
                            <i class="fas fa-wallet"></i> Gestionar Saldo
                        </h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #333;">
                            <i class="fas fa-${esUsuario ? 'user' : 'building'}"></i> 
                            ${esUsuario ? cuenta.nombre + ' ' + (cuenta.apellido || '') : cuenta.razonSocial}
                        </h3>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="flex: 1;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">Saldo Actual</div>
                                <div style="font-size: 2rem; font-weight: bold; color: #27ae60;">
                                    $${(cuenta.saldo || 0).toLocaleString('es-CL')}
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">Email</div>
                                <div style="font-size: 0.95rem; color: #333;">${cuenta.email}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                            <i class="fas fa-exchange-alt"></i> Tipo de Operaci贸n
                        </label>
                        <select id="tipo-operacion" style="width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <option value="agregar"> Agregar Saldo (Dep贸sito)</option>
                            <option value="retirar"> Retirar Saldo (Retiro)</option>
                            <option value="ajustar">锔 Ajustar Saldo (Correcci贸n)</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                            <i class="fas fa-dollar-sign"></i> Monto
                        </label>
                        <input type="number" id="monto-operacion" placeholder="Ingrese el monto" min="0" step="1000"
                            style="width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                            <i class="fas fa-comment"></i> Concepto / Raz贸n
                        </label>
                        <textarea id="concepto-operacion" placeholder="Describa el motivo de la operaci贸n" rows="3"
                            style="width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="this.closest('.modal').remove()" 
                            style="flex: 1; padding: 0.8rem; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button onclick="ejecutarOperacionSaldo('${cuenta.id}', ${esUsuario}, this)" 
                            style="flex: 1; padding: 0.8rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-check"></i> Confirmar Operaci贸n
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Focus en el input de monto
            setTimeout(() => document.getElementById('monto-operacion').focus(), 100);
        }
        
        // Ejecutar la operaci贸n de saldo
        async function ejecutarOperacionSaldo(cuentaId, esUsuario, btn) {
            // Obtener elementos del modal actual
            const modal = btn.closest('.modal');
            const tipoOperacionEl = modal.querySelector('#tipo-operacion');
            const montoInputEl = modal.querySelector('#monto-operacion');
            const conceptoEl = modal.querySelector('#concepto-operacion');
            
            if (!tipoOperacionEl || !montoInputEl || !conceptoEl) {
                console.error('No se encontraron los elementos del formulario');
                notify.error('Error: No se pudieron encontrar los campos del formulario');
                return;
            }
            
            const tipoOperacion = tipoOperacionEl.value;
            const montoInput = montoInputEl.value;
            const concepto = conceptoEl.value.trim();
            
            console.log('Valores capturados:', { tipoOperacion, montoInput, concepto });
            
            // Validaciones
            if (!montoInput || montoInput.trim() === '') {
                notify.error('Debe ingresar un monto');
                return;
            }
            
            const monto = parseFloat(montoInput);
            
            if (isNaN(monto) || monto <= 0) {
                notify.error('Debe ingresar un monto v谩lido mayor a 0');
                return;
            }
            
            if (!concepto) {
                notify.error('Debe ingresar un concepto para la operaci贸n');
                return;
            }
            
            // Obtener la cuenta
            let cuentas = esUsuario ? auth.getUsers() : auth.getEmpresas();
            const index = cuentas.findIndex(c => c.id === cuentaId);
            
            if (index === -1) {
                notify.error('Cuenta no encontrada');
                return;
            }
            
            const cuenta = cuentas[index];
            const saldoAnterior = cuenta.saldo || 0;
            let nuevoSaldo = saldoAnterior;
            let tipoTransaccion = '';
            
            // Calcular nuevo saldo seg煤n tipo de operaci贸n
            if (tipoOperacion === 'agregar') {
                nuevoSaldo = saldoAnterior + monto;
                tipoTransaccion = 'deposito';
            } else if (tipoOperacion === 'retirar') {
                if (monto > saldoAnterior) {
                    const confirmar = await notify.confirm(
                        'El monto a retirar es mayor al saldo actual. 驴Desea continuar? El saldo quedar谩 negativo.',
                        'Saldo Insuficiente'
                    );
                    if (!confirmar) return;
                }
                nuevoSaldo = saldoAnterior - monto;
                tipoTransaccion = 'retiro';
            } else if (tipoOperacion === 'ajustar') {
                nuevoSaldo = monto;
                tipoTransaccion = 'ajuste';
            }
            
            // Generar ID de ticket 煤nico
            const ticketId = 'TKT-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            
            // Crear registro de transacci贸n
            const transaccion = {
                id: ticketId,
                ticketId: ticketId,
                fecha: new Date().toISOString(),
                tipo: tipoTransaccion,
                monto: tipoOperacion === 'ajustar' ? Math.abs(nuevoSaldo - saldoAnterior) : monto,
                saldoAnterior: saldoAnterior,
                saldoNuevo: nuevoSaldo,
                concepto: concepto,
                descripcion: `${tipoOperacion === 'agregar' ? 'Dep贸sito' : tipoOperacion === 'retirar' ? 'Retiro' : 'Ajuste'} realizado por administrador`,
                realizadoPor: 'admin'
            };
            
            // Actualizar cuenta
            cuenta.saldo = nuevoSaldo;
            if (!cuenta.transacciones) cuenta.transacciones = [];
            cuenta.transacciones.push(transaccion);
            
            // Guardar cambios
            cuentas[index] = cuenta;
            if (esUsuario) {
                localStorage.setItem('nexos_users', JSON.stringify(cuentas));
            } else {
                localStorage.setItem('nexos_empresas', JSON.stringify(cuentas));
            }
            
            // Registrar en log
            const nombreCuenta = esUsuario ? cuenta.nombre : cuenta.razonSocial;
            const montoFormateado = monto.toLocaleString('es-CL');
            const nuevoSaldoFormateado = nuevoSaldo.toLocaleString('es-CL');
            agregarLog('[FINANZAS] Operaci贸n de ' + tipoTransaccion + ' de $' + montoFormateado + ' realizada en cuenta de ' + nombreCuenta + '. Ticket: ' + ticketId);
            
            // Cerrar modal y notificar
            btn.closest('.modal').remove();
            notify.success('Operaci贸n exitosa. Nuevo saldo: $' + nuevoSaldoFormateado);
            
            // Recargar datos
            cargarTodasCuentas();
            cargarDashboardPrincipal();
        }

        function cargarPendientes() {
            const pendientes = auth.getEmpresasPendientes();
            const tbody = document.getElementById('tabla-pendientes');

            if (pendientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay solicitudes pendientes</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = '';
            pendientes.forEach(function(empresa) {
                const fecha = new Date(empresa.fechaRegistro).toLocaleDateString();
                
                // Verificar documentos
                let documentosHtml = '';
                if (empresa.documentosLegales) {
                    const numDocs = (empresa.documentosLegales.inicioActividades ? 1 : 0) + 
                                   (empresa.documentosLegales.certificadoVigencia ? 1 : 0) + 
                                   (empresa.documentosLegales.estatutos ? 1 : 0);
                    documentosHtml = '<button class="btn-action" style="background: #27ae60; color: white;" onclick="verDocumentosEmpresa(\'' + empresa.id + '\', \'pendiente\')" title="Ver documentos legales">' +
                        '<i class="fas fa-file-contract"></i> ' + numDocs + ' doc(s)' +
                        '</button>';
                } else {
                    documentosHtml = '<span style="color: #e74c3c; font-size: 0.9rem;"><i class="fas fa-exclamation-triangle"></i> Sin docs</span>';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + empresa.razonSocial + '</td>' +
                    '<td>' + empresa.rut + '</td>' +
                    '<td>' + empresa.email + '</td>' +
                    '<td>' + fecha + '</td>' +
                    '<td>' + documentosHtml + '</td>' +
                    '<td><div class="action-buttons">' +
                    '<button class="btn-action btn-view" onclick="verDetalles(\'' + empresa.id + '\', \'pendiente\')">' +
                    '<i class="fas fa-eye"></i> Ver</button>' +
                    '<button class="btn-action btn-approve" onclick="aprobar(\'' + empresa.id + '\')">' +
                    '<i class="fas fa-check"></i> Aprobar</button>' +
                    '<button class="btn-action btn-reject" onclick="rechazar(\'' + empresa.id + '\')">' +
                    '<i class="fas fa-times"></i> Rechazar</button>' +
                    '</div></td>';
                tbody.appendChild(row);
            });
        }

        function cargarEmpresas() {
            const empresas = auth.getEmpresas();
            const tbody = document.getElementById('tabla-empresas');

            if (empresas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay empresas registradas</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = '';
            empresas.forEach(function(empresa) {
                const rolBadge = empresa.role === 'admin' ? 'admin' : 'user';
                const estadoBadge = empresa.estado || 'aprobada';
                const isAdmin = empresa.role === 'admin';
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + empresa.razonSocial + '</td>' +
                    '<td>' + empresa.rut + '</td>' +
                    '<td>' + empresa.email + '</td>' +
                    '<td><span class="badge ' + rolBadge + '">' + empresa.role + '</span></td>' +
                    '<td><span class="badge ' + estadoBadge + '">' + (empresa.estado || 'aprobada') + '</span></td>' +
                    '<td><div class="action-buttons">' +
                    '<button class="btn-action btn-view" onclick="verDetalles(\'' + empresa.id + '\', \'empresa\')" title="Ver detalles">' +
                    '<i class="fas fa-eye"></i></button>' +
                    '<button class="btn-action btn-edit" onclick="abrirModalPassword(\'' + empresa.id + '\', \'empresa\')" title="Cambiar contrase帽a">' +
                    '<i class="fas fa-key"></i></button>' +
                    (isAdmin ? '' : '<button class="btn-action btn-delete" onclick="eliminarCuenta(\'' + empresa.id + '\', \'empresa\')" title="Eliminar empresa">' +
                    '<i class="fas fa-trash"></i></button>') +
                    '</div></td>';
                tbody.appendChild(row);
            });
        }

        function cargarUsuarios() {
            const usuarios = auth.getUsers();
            const tbody = document.getElementById('tabla-usuarios');

            if (usuarios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay usuarios registrados</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = '';
            usuarios.forEach(function(usuario) {
                const fecha = new Date(usuario.fechaRegistro).toLocaleDateString();
                const rolBadge = usuario.role === 'admin' ? 'admin' : 'user';
                const isAdmin = usuario.role === 'admin';
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + usuario.nombre + ' ' + usuario.apellido + '</td>' +
                    '<td>' + usuario.username + '</td>' +
                    '<td>' + (usuario.rut || 'N/A') + '</td>' +
                    '<td>' + usuario.email + '</td>' +
                    '<td><span class="badge ' + rolBadge + '">' + usuario.role + '</span></td>' +
                    '<td>' + fecha + '</td>' +
                    '<td><div class="action-buttons">' +
                    '<button class="btn-action btn-view" onclick="verDetalles(\'' + usuario.id + '\', \'usuario\')" title="Ver detalles">' +
                    '<i class="fas fa-eye"></i></button>' +
                    '<button class="btn-action btn-edit" onclick="abrirModalPassword(\'' + usuario.id + '\', \'usuario\')" title="Cambiar contrase帽a">' +
                    '<i class="fas fa-key"></i></button>' +
                    (isAdmin ? '' : '<button class="btn-action btn-delete" onclick="eliminarCuenta(\'' + usuario.id + '\', \'usuario\')" title="Eliminar usuario">' +
                    '<i class="fas fa-trash"></i></button>') +
                    '</div></td>';
                tbody.appendChild(row);
            });
        }

        function cargarRechazadas() {
            const rechazadas = auth.getEmpresasRechazadas();
            const tbody = document.getElementById('tabla-rechazadas');

            if (rechazadas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay solicitudes rechazadas</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = '';
            rechazadas.forEach(function(empresa) {
                const fecha = new Date(empresa.fechaRechazo).toLocaleDateString();
                const row = document.createElement('tr');
                row.innerHTML = '<td>' + empresa.razonSocial + '</td>' +
                    '<td>' + empresa.rut + '</td>' +
                    '<td>' + empresa.email + '</td>' +
                    '<td>' + fecha + '</td>' +
                    '<td>' + (empresa.motivoRechazo || 'Sin motivo especificado') + '</td>' +
                    '<td><div class="action-buttons">' +
                    '<button class="btn-action btn-view" onclick="verDetalles(\'' + empresa.id + '\', \'rechazada\')">' +
                    '<i class="fas fa-eye"></i> Ver</button>' +
                    '</div></td>';
                tbody.appendChild(row);
            });
        }

        // ===== FUNCIONES DE SUBASTAS =====

        function cargarTodasSubastas() {
            const subastas = JSON.parse(localStorage.getItem('nexos_subastas') || '[]');
            const tbody = document.getElementById('tabla-subastas-admin');

            if (subastas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="fas fa-gavel"></i><p>No hay subastas registradas</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = subastas.map(subasta => {
                const tipoIcons = {
                    'subasta': { icon: 'fa-gavel', color: '#4a90e2' },
                    'rifa': { icon: 'fa-ticket-alt', color: '#f39c12' },
                    'venta': { icon: 'fa-shopping-cart', color: '#50c878' }
                };
                const tipoInfo = tipoIcons[subasta.tipo] || tipoIcons.subasta;

                const estadoColors = {
                    'activa': { bg: '#d4edda', color: '#155724' },
                    'finalizada': { bg: '#d1ecf1', color: '#0c5460' },
                    'cancelada': { bg: '#f8d7da', color: '#721c24' }
                };
                const estadoInfo = estadoColors[subasta.estado] || estadoColors.activa;

                const fechaFin = subasta.fechaFin ? new Date(subasta.fechaFin).toLocaleDateString('es-CL') : 'N/A';
                const numPujas = (subasta.pujas || []).length;

                return `
                    <tr>
                        <td style="font-weight: 600;">${subasta.titulo}</td>
                        <td>${subasta.empresaNombre || 'N/A'}</td>
                        <td>
                            <span style="background: ${tipoInfo.color}; color: white; padding: 0.3rem 0.7rem; border-radius: 8px; font-size: 0.85rem;">
                                <i class="fas ${tipoInfo.icon}"></i> ${subasta.tipo}
                            </span>
                        </td>
                        <td style="font-weight: 700; color: #27ae60;">$${(subasta.precioActual || subasta.precioInicial || 0).toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: #f0f0f0; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 600;">
                                ${numPujas} pujas
                            </span>
                        </td>
                        <td>
                            <span style="background: ${estadoInfo.bg}; color: ${estadoInfo.color}; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">
                                ${subasta.estado}
                            </span>
                        </td>
                        <td>${fechaFin}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="window.open('detalle-subasta.html?id=${subasta.id}', '_blank')">
                                    <i class="fas fa-external-link-alt"></i> Ver
                                </button>
                                ${subasta.estado === 'activa' ? `
                                <button class="btn-action btn-reject" onclick="cancelarSubasta('${subasta.id}')">
                                    <i class="fas fa-ban"></i> Cancelar
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            window.todasLasSubastas = subastas;
        }

        function filtrarSubastas() {
            const busqueda = document.getElementById('buscar-subasta').value.toLowerCase();
            const estadoFiltro = document.getElementById('filtro-estado-subasta').value;

            if (!window.todasLasSubastas) {
                cargarTodasSubastas();
                return;
            }

            let subastasFiltradas = window.todasLasSubastas.filter(subasta => {
                const matchBusqueda = !busqueda || 
                    subasta.titulo.toLowerCase().includes(busqueda) ||
                    (subasta.empresaNombre && subasta.empresaNombre.toLowerCase().includes(busqueda));

                const matchEstado = estadoFiltro === 'all' || subasta.estado === estadoFiltro;

                return matchBusqueda && matchEstado;
            });

            const tbody = document.getElementById('tabla-subastas-admin');

            if (subastasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="fas fa-search"></i><p>No se encontraron subastas</p></div></td></tr>';
                return;
            }

            // Renderizar resultados filtrados (mismo c贸digo que en cargarTodasSubastas)
            tbody.innerHTML = subastasFiltradas.map(subasta => {
                const tipoIcons = {
                    'subasta': { icon: 'fa-gavel', color: '#4a90e2' },
                    'rifa': { icon: 'fa-ticket-alt', color: '#f39c12' },
                    'venta': { icon: 'fa-shopping-cart', color: '#50c878' }
                };
                const tipoInfo = tipoIcons[subasta.tipo] || tipoIcons.subasta;

                const estadoColors = {
                    'activa': { bg: '#d4edda', color: '#155724' },
                    'finalizada': { bg: '#d1ecf1', color: '#0c5460' },
                    'cancelada': { bg: '#f8d7da', color: '#721c24' }
                };
                const estadoInfo = estadoColors[subasta.estado] || estadoColors.activa;

                const fechaFin = subasta.fechaFin ? new Date(subasta.fechaFin).toLocaleDateString('es-CL') : 'N/A';
                const numPujas = (subasta.pujas || []).length;

                return `
                    <tr>
                        <td style="font-weight: 600;">${subasta.titulo}</td>
                        <td>${subasta.empresaNombre || 'N/A'}</td>
                        <td>
                            <span style="background: ${tipoInfo.color}; color: white; padding: 0.3rem 0.7rem; border-radius: 8px; font-size: 0.85rem;">
                                <i class="fas ${tipoInfo.icon}"></i> ${subasta.tipo}
                            </span>
                        </td>
                        <td style="font-weight: 700; color: #27ae60;">$${(subasta.precioActual || subasta.precioInicial || 0).toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: #f0f0f0; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 600;">
                                ${numPujas} pujas
                            </span>
                        </td>
                        <td>
                            <span style="background: ${estadoInfo.bg}; color: ${estadoInfo.color}; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">
                                ${subasta.estado}
                            </span>
                        </td>
                        <td>${fechaFin}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="window.open('detalle-subasta.html?id=${subasta.id}', '_blank')">
                                    <i class="fas fa-external-link-alt"></i> Ver
                                </button>
                                ${subasta.estado === 'activa' ? `
                                <button class="btn-action btn-reject" onclick="cancelarSubasta('${subasta.id}')">
                                    <i class="fas fa-ban"></i> Cancelar
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function cancelarSubasta(id) {
            const confirmado = await notify.confirm(
                '驴Est谩s seguro de cancelar esta subasta? Esta acci贸n no se puede deshacer.',
                'Cancelar Subasta'
            );

            if (!confirmado) return;

            const subastas = JSON.parse(localStorage.getItem('nexos_subastas') || '[]');
            const index = subastas.findIndex(s => s.id === id);

            if (index !== -1) {
                subastas[index].estado = 'cancelada';
                localStorage.setItem('nexos_subastas', JSON.stringify(subastas));
                notify.success('Subasta cancelada exitosamente');
                cargarTodasSubastas();
            }
        }

        // ===== FUNCIONES DE RIFAS =====

        function cargarTodasRifas() {
            const rifas = JSON.parse(localStorage.getItem('nexos_rifas') || '[]');
            const tbody = document.getElementById('tabla-rifas-admin');

            if (rifas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><i class="fas fa-ticket-alt"></i><p>No hay rifas registradas</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = rifas.map(rifa => {
                const estadoColors = {
                    'activa': { bg: '#d4edda', color: '#155724' },
                    'proxima': { bg: '#fff3cd', color: '#856404' },
                    'finalizada': { bg: '#d1ecf1', color: '#0c5460' },
                    'cancelada': { bg: '#f8d7da', color: '#721c24' }
                };
                const estadoInfo = estadoColors[rifa.estado] || estadoColors.activa;

                const fechaSorteo = rifa.fechaSorteo ? new Date(rifa.fechaSorteo).toLocaleDateString('es-CL') : 'N/A';
                const totalBoletos = rifa.totalBoletos || 0;
                const boletosVendidos = (rifa.boletos || []).filter(b => b.vendido).length;
                const recaudado = boletosVendidos * (rifa.precioBoleto || 0);
                const porcentajeVenta = totalBoletos > 0 ? ((boletosVendidos / totalBoletos) * 100).toFixed(1) : 0;

                return `
                    <tr>
                        <td style="font-weight: 600;">${rifa.titulo}</td>
                        <td>${rifa.empresaNombre || 'N/A'}</td>
                        <td style="font-weight: 700; color: #27ae60;">$${(rifa.precioBoleto || 0).toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: #f0f0f0; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 600;">
                                ${totalBoletos}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-weight: 600;">${boletosVendidos}</span>
                                <span style="font-size: 0.85rem; color: #666;">(${porcentajeVenta}%)</span>
                            </div>
                        </td>
                        <td style="font-weight: 700; color: #27ae60;">$${recaudado.toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: ${estadoInfo.bg}; color: ${estadoInfo.color}; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">
                                ${rifa.estado}
                            </span>
                        </td>
                        <td>${fechaSorteo}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="window.open('detalle-rifa.html?id=${rifa.id}', '_blank')">
                                    <i class="fas fa-external-link-alt"></i> Ver
                                </button>
                                ${rifa.estado === 'activa' ? `
                                <button class="btn-action btn-approve" onclick="realizarSorteoAdmin('${rifa.id}')">
                                    <i class="fas fa-dice"></i> Sortear
                                </button>
                                <button class="btn-action btn-reject" onclick="cancelarRifa('${rifa.id}')">
                                    <i class="fas fa-ban"></i> Cancelar
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            window.todasLasRifas = rifas;
        }

        function filtrarRifasAdmin() {
            const busqueda = document.getElementById('buscar-rifa').value.toLowerCase();
            const estadoFiltro = document.getElementById('filtro-estado-rifa').value;

            if (!window.todasLasRifas) {
                cargarTodasRifas();
                return;
            }

            let rifasFiltradas = window.todasLasRifas.filter(rifa => {
                const matchBusqueda = !busqueda || 
                    rifa.titulo.toLowerCase().includes(busqueda) ||
                    (rifa.empresaNombre && rifa.empresaNombre.toLowerCase().includes(busqueda));

                const matchEstado = estadoFiltro === 'all' || rifa.estado === estadoFiltro;

                return matchBusqueda && matchEstado;
            });

            const tbody = document.getElementById('tabla-rifas-admin');

            if (rifasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><i class="fas fa-search"></i><p>No se encontraron rifas</p></div></td></tr>';
                return;
            }

            // Renderizar resultados filtrados
            tbody.innerHTML = rifasFiltradas.map(rifa => {
                const estadoColors = {
                    'activa': { bg: '#d4edda', color: '#155724' },
                    'proxima': { bg: '#fff3cd', color: '#856404' },
                    'finalizada': { bg: '#d1ecf1', color: '#0c5460' },
                    'cancelada': { bg: '#f8d7da', color: '#721c24' }
                };
                const estadoInfo = estadoColors[rifa.estado] || estadoColors.activa;

                const fechaSorteo = rifa.fechaSorteo ? new Date(rifa.fechaSorteo).toLocaleDateString('es-CL') : 'N/A';
                const totalBoletos = rifa.totalBoletos || 0;
                const boletosVendidos = (rifa.boletos || []).filter(b => b.vendido).length;
                const recaudado = boletosVendidos * (rifa.precioBoleto || 0);
                const porcentajeVenta = totalBoletos > 0 ? ((boletosVendidos / totalBoletos) * 100).toFixed(1) : 0;

                return `
                    <tr>
                        <td style="font-weight: 600;">${rifa.titulo}</td>
                        <td>${rifa.empresaNombre || 'N/A'}</td>
                        <td style="font-weight: 700; color: #27ae60;">$${(rifa.precioBoleto || 0).toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: #f0f0f0; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 600;">
                                ${totalBoletos}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-weight: 600;">${boletosVendidos}</span>
                                <span style="font-size: 0.85rem; color: #666;">(${porcentajeVenta}%)</span>
                            </div>
                        </td>
                        <td style="font-weight: 700; color: #27ae60;">$${recaudado.toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: ${estadoInfo.bg}; color: ${estadoInfo.color}; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">
                                ${rifa.estado}
                            </span>
                        </td>
                        <td>${fechaSorteo}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="window.open('detalle-rifa.html?id=${rifa.id}', '_blank')">
                                    <i class="fas fa-external-link-alt"></i> Ver
                                </button>
                                ${rifa.estado === 'activa' ? `
                                <button class="btn-action btn-approve" onclick="realizarSorteoAdmin('${rifa.id}')">
                                    <i class="fas fa-dice"></i> Sortear
                                </button>
                                <button class="btn-action btn-reject" onclick="cancelarRifa('${rifa.id}')">
                                    <i class="fas fa-ban"></i> Cancelar
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function cancelarRifa(id) {
            const confirmado = await notify.confirm(
                '驴Est谩s seguro de cancelar esta rifa? Esta acci贸n no se puede deshacer.',
                'Cancelar Rifa'
            );

            if (!confirmado) return;

            const rifas = JSON.parse(localStorage.getItem('nexos_rifas') || '[]');
            const index = rifas.findIndex(r => r.id === id);

            if (index !== -1) {
                rifas[index].estado = 'cancelada';
                localStorage.setItem('nexos_rifas', JSON.stringify(rifas));
                notify.success('Rifa cancelada exitosamente');
                cargarTodasRifas();
            }
        }

        async function realizarSorteoAdmin(rifaId) {
            const confirmado = await notify.confirm(
                '驴Deseas realizar el sorteo ahora? Se seleccionar谩 un ganador aleatorio.',
                'Realizar Sorteo'
            );

            if (!confirmado) return;

            const rifas = JSON.parse(localStorage.getItem('nexos_rifas') || '[]');
            const rifa = rifas.find(r => r.id === rifaId);

            if (!rifa) {
                notify.error('Rifa no encontrada');
                return;
            }

            const boletosVendidos = rifa.boletos.filter(b => b.vendido);

            if (boletosVendidos.length === 0) {
                notify.error('No hay boletos vendidos para realizar el sorteo');
                return;
            }

            const ganadorIndex = Math.floor(Math.random() * boletosVendidos.length);
            const ganador = boletosVendidos[ganadorIndex];

            rifa.ganador = ganador;
            rifa.estado = 'finalizada';

            const index = rifas.findIndex(r => r.id === rifaId);
            rifas[index] = rifa;
            localStorage.setItem('nexos_rifas', JSON.stringify(rifas));

            notify.success(`隆Sorteo realizado! Ganador: Boleto #${ganador.numero} (${ganador.comprador})`);
            cargarTodasRifas();
        }

        // ===== FUNCIONES DE PRODUCTOS =====

        function cargarTodosProductos() {
            const productos = JSON.parse(localStorage.getItem('nexos_productos') || '[]');
            const tbody = document.getElementById('tabla-productos-admin');

            if (productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><i class="fas fa-shopping-cart"></i><p>No hay productos registrados</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = productos.map(producto => {
                const stockActual = producto.stock || 0;
                const stockInicial = producto.stockInicial || producto.stock || 0;
                const vendidos = stockInicial - stockActual;
                const recaudado = vendidos * (producto.precio || 0);
                
                const estadoStock = stockActual === 0 ? 'Agotado' : stockActual < 10 ? 'Bajo' : 'Disponible';
                const estadoColor = stockActual === 0 ? '#f8d7da' : stockActual < 10 ? '#fff3cd' : '#d4edda';
                const estadoTextColor = stockActual === 0 ? '#721c24' : stockActual < 10 ? '#856404' : '#155724';

                return `
                    <tr>
                        <td style="font-weight: 600;">${producto.nombre}</td>
                        <td>${producto.empresaNombre || 'N/A'}</td>
                        <td>
                            <span style="background: #f0f0f0; padding: 0.3rem 0.7rem; border-radius: 8px; font-size: 0.85rem;">
                                ${producto.categoria || 'Otros'}
                            </span>
                        </td>
                        <td style="font-weight: 700; color: #27ae60;">$${(producto.precio || 0).toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: ${estadoColor}; color: ${estadoTextColor}; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 600;">
                                ${stockActual}
                            </span>
                        </td>
                        <td>
                            <span style="background: #f0f0f0; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 600;">
                                ${vendidos}
                            </span>
                        </td>
                        <td style="font-weight: 700; color: #27ae60;">$${recaudado.toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: ${estadoColor}; color: ${estadoTextColor}; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">
                                ${estadoStock}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="window.open('detalle-producto.html?id=${producto.id}', '_blank')">
                                    <i class="fas fa-external-link-alt"></i> Ver
                                </button>
                                <button class="btn-action btn-approve" onclick="editarStockProducto('${producto.id}')">
                                    <i class="fas fa-boxes"></i> Stock
                                </button>
                                ${stockActual === 0 ? `
                                <button class="btn-action btn-reject" onclick="desactivarProducto('${producto.id}')">
                                    <i class="fas fa-ban"></i> Desactivar
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            window.todosLosProductos = productos;
        }

        function filtrarProductosAdmin() {
            const busqueda = document.getElementById('buscar-producto').value.toLowerCase();
            const categoriaFiltro = document.getElementById('filtro-categoria-producto').value;

            if (!window.todosLosProductos) {
                cargarTodosProductos();
                return;
            }

            let productosFiltrados = window.todosLosProductos.filter(producto => {
                const matchBusqueda = !busqueda || 
                    producto.nombre.toLowerCase().includes(busqueda) ||
                    (producto.empresaNombre && producto.empresaNombre.toLowerCase().includes(busqueda));

                const matchCategoria = categoriaFiltro === 'all' || producto.categoria === categoriaFiltro;

                return matchBusqueda && matchCategoria;
            });

            const tbody = document.getElementById('tabla-productos-admin');

            if (productosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><i class="fas fa-search"></i><p>No se encontraron productos</p></div></td></tr>';
                return;
            }

            // Renderizar resultados filtrados
            tbody.innerHTML = productosFiltrados.map(producto => {
                const stockActual = producto.stock || 0;
                const stockInicial = producto.stockInicial || producto.stock || 0;
                const vendidos = stockInicial - stockActual;
                const recaudado = vendidos * (producto.precio || 0);
                
                const estadoStock = stockActual === 0 ? 'Agotado' : stockActual < 10 ? 'Bajo' : 'Disponible';
                const estadoColor = stockActual === 0 ? '#f8d7da' : stockActual < 10 ? '#fff3cd' : '#d4edda';
                const estadoTextColor = stockActual === 0 ? '#721c24' : stockActual < 10 ? '#856404' : '#155724';

                return `
                    <tr>
                        <td style="font-weight: 600;">${producto.nombre}</td>
                        <td>${producto.empresaNombre || 'N/A'}</td>
                        <td>
                            <span style="background: #f0f0f0; padding: 0.3rem 0.7rem; border-radius: 8px; font-size: 0.85rem;">
                                ${producto.categoria || 'Otros'}
                            </span>
                        </td>
                        <td style="font-weight: 700; color: #27ae60;">$${(producto.precio || 0).toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: ${estadoColor}; color: ${estadoTextColor}; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 600;">
                                ${stockActual}
                            </span>
                        </td>
                        <td>
                            <span style="background: #f0f0f0; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 600;">
                                ${vendidos}
                            </span>
                        </td>
                        <td style="font-weight: 700; color: #27ae60;">$${recaudado.toLocaleString('es-CL')}</td>
                        <td>
                            <span style="background: ${estadoColor}; color: ${estadoTextColor}; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">
                                ${estadoStock}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="window.open('detalle-producto.html?id=${producto.id}', '_blank')">
                                    <i class="fas fa-external-link-alt"></i> Ver
                                </button>
                                <button class="btn-action btn-approve" onclick="editarStockProducto('${producto.id}')">
                                    <i class="fas fa-boxes"></i> Stock
                                </button>
                                ${stockActual === 0 ? `
                                <button class="btn-action btn-reject" onclick="desactivarProducto('${producto.id}')">
                                    <i class="fas fa-ban"></i> Desactivar
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function editarStockProducto(id) {
            const productos = JSON.parse(localStorage.getItem('nexos_productos') || '[]');
            const producto = productos.find(p => p.id === id);

            if (!producto) {
                notify.error('Producto no encontrado');
                return;
            }

            const nuevoStock = prompt(`Stock actual: ${producto.stock}\n\nIngresa el nuevo stock:`, producto.stock);

            if (nuevoStock === null) return;

            const stockNumero = parseInt(nuevoStock);

            if (isNaN(stockNumero) || stockNumero < 0) {
                notify.error('Por favor ingresa un n煤mero v谩lido');
                return;
            }

            producto.stock = stockNumero;
            const index = productos.findIndex(p => p.id === id);
            productos[index] = producto;
            localStorage.setItem('nexos_productos', JSON.stringify(productos));

            notify.success('Stock actualizado exitosamente');
            cargarTodosProductos();
        }

        async function desactivarProducto(id) {
            const confirmado = await notify.confirm(
                '驴Est谩s seguro de desactivar este producto? Esta acci贸n no se puede deshacer.',
                'Desactivar Producto'
            );

            if (!confirmado) return;

            const productos = JSON.parse(localStorage.getItem('nexos_productos') || '[]');
            const index = productos.findIndex(p => p.id === id);

            if (index !== -1) {
                productos[index].activo = false;
                localStorage.setItem('nexos_productos', JSON.stringify(productos));
                notify.success('Producto desactivado exitosamente');
                cargarTodosProductos();
            }
        }

        // ===== FUNCIONES DE SISTEMA =====

        function calcularEspacioUsado() {
            let totalBytes = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalBytes += localStorage[key].length + key.length;
                }
            }
            const kb = (totalBytes / 1024).toFixed(2);
            document.getElementById('espacio-usado').textContent = kb + ' KB';

            const usuarios = auth.getUsers().length;
            const empresas = auth.getEmpresas().length;
            const subastas = JSON.parse(localStorage.getItem('nexos_subastas') || '[]').length;
            const totalRegistros = usuarios + empresas + subastas;
            document.getElementById('total-registros').textContent = totalRegistros;
        }

        async function exportarDatos() {
            const data = {
                usuarios: auth.getUsers(),
                empresas: auth.getEmpresas(),
                subastas: JSON.parse(localStorage.getItem('nexos_subastas') || '[]'),
                pendientes: auth.getEmpresasPendientes(),
                rechazadas: auth.getEmpresasRechazadas(),
                fecha: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `nexos-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            notify.success('Datos exportados exitosamente');
            agregarLog('[EXPORT] Datos del sistema exportados');
        }

        async function limpiarCache() {
            const confirmado = await notify.confirm(
                'Esto limpiar谩 datos temporales pero mantendr谩 la informaci贸n principal. 驴Continuar?',
                'Limpiar Cach茅'
            );

            if (!confirmado) return;

            // Aqu铆 podr铆as limpiar datos temporales espec铆ficos
            notify.success('Cach茅 limpiado exitosamente');
            agregarLog('[CACHE] Cach茅 del sistema limpiado');
        }

        async function reiniciarSistema() {
            const confirmado = await notify.confirm(
                '锔 ADVERTENCIA: Esto eliminar谩 TODOS los datos del sistema excepto el admin. 驴Est谩s seguro?',
                'Reiniciar Sistema'
            );

            if (!confirmado) return;

            const confirmado2 = await notify.confirm(
                'Esta acci贸n es IRREVERSIBLE. 驴Realmente deseas continuar?',
                'Confirmaci贸n Final'
            );

            if (!confirmado2) return;

            // Mantener solo el admin
            const usuarios = auth.getUsers();
            const adminUser = usuarios.find(u => u.username === 'admin');

            localStorage.setItem('nexos_users', JSON.stringify(adminUser ? [adminUser] : []));
            localStorage.setItem('nexos_empresas', JSON.stringify([]));
            localStorage.setItem('nexos_empresas_pendientes', JSON.stringify([]));
            localStorage.setItem('nexos_empresas_rechazadas', JSON.stringify([]));
            localStorage.setItem('nexos_subastas', JSON.stringify([]));
            localStorage.setItem('nexos_password_reset_requests', JSON.stringify([]));

            notify.success('Sistema reiniciado exitosamente');
            agregarLog('[RESET] Sistema reiniciado - Todos los datos eliminados');
            
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        async function generarReporte() {
            notify.info('Generando reporte completo del sistema...');
            
            const usuarios = auth.getUsers();
            const empresas = auth.getEmpresas();
            const subastas = JSON.parse(localStorage.getItem('nexos_subastas') || '[]');

            const reporte = `
=================================================
        REPORTE DEL SISTEMA NEXOS
=================================================
Fecha: ${new Date().toLocaleString('es-CL')}

ESTADSTICAS GENERALES:
- Total de Usuarios: ${usuarios.length}
- Total de Empresas: ${empresas.length}
- Total de Subastas: ${subastas.length}

FINANZAS:
- Circulaci贸n en Usuarios: $${usuarios.reduce((sum, u) => sum + (u.saldo || 0), 0).toLocaleString('es-CL')}
- Circulaci贸n en Empresas: $${empresas.reduce((sum, e) => sum + (e.saldo || 0), 0).toLocaleString('es-CL')}

SUBASTAS:
- Activas: ${subastas.filter(s => s.estado === 'activa').length}
- Finalizadas: ${subastas.filter(s => s.estado === 'finalizada').length}
- Canceladas: ${subastas.filter(s => s.estado === 'cancelada').length}

=================================================
            `;

            const blob = new Blob([reporte], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `reporte-nexos-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();

            notify.success('Reporte generado exitosamente');
            agregarLog('[REPORT] Reporte del sistema generado');
        }

        function agregarLog(mensaje) {
            const logsDiv = document.getElementById('system-logs');
            const timestamp = new Date().toLocaleTimeString('es-CL');
            const logEntry = document.createElement('p');
            logEntry.style.margin = '0';
            logEntry.textContent = `[${timestamp}] ${mensaje}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // ===== FUNCIONES DE RESTABLECIMIENTOS =====

        function cargarRestablecimientos() {
            const requests = auth.getPasswordResetRequests();
            const tbody = document.getElementById('tabla-restablecimientos');

            if (!requests || requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-inbox"></i><p>No hay solicitudes de restablecimiento</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = '';
            requests.forEach(function(req) {
                const fecha = new Date(req.createdAt).toLocaleString('es-ES', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const tipoLabel = req.type === 'empresa' ? '<span class="badge approved"><i class="fas fa-building"></i> Empresa</span>' : '<span class="badge user"><i class="fas fa-user"></i> Usuario</span>';
                const estadoBadge = req.status === 'pendiente' ? 'pending' : (req.status === 'aprobada' ? 'approved' : 'rejected');
                const estadoLabel = req.status === 'pendiente' ? 'Pendiente' : (req.status === 'aprobada' ? 'Aprobada' : 'Rechazada');

                let accionesHTML = '';
                if (req.status === 'pendiente' && req.type === 'empresa') {
                    accionesHTML = '<button class="btn-action btn-approve" onclick="abrirModalAprobarReset(\'' + req.id + '\')" title="Aprobar solicitud">' +
                        '<i class="fas fa-check"></i> Aprobar</button>' +
                        '<button class="btn-action btn-reject" onclick="abrirModalRechazarReset(\'' + req.id + '\')" title="Rechazar solicitud">' +
                        '<i class="fas fa-times"></i> Rechazar</button>';
                } else {
                    accionesHTML = '<button class="btn-action btn-view" onclick="verDetalleReset(\'' + req.id + '\')" title="Ver detalles">' +
                        '<i class="fas fa-eye"></i> Ver</button>';
                }

                const row = document.createElement('tr');
                row.innerHTML = '<td>' + tipoLabel + '</td>' +
                    '<td><strong>' + req.displayName + '</strong><br><small style="color: #666;">@' + req.username + '</small></td>' +
                    '<td>' + req.email + '</td>' +
                    '<td>' + fecha + '</td>' +
                    '<td><span class="badge ' + estadoBadge + '">' + estadoLabel + '</span></td>' +
                    '<td><div class="action-buttons">' + accionesHTML + '</div></td>';

                tbody.appendChild(row);
            });
        }

        let resetRequestIdActual = null;

        async function abrirModalAprobarReset(requestId) {
            const requests = auth.getPasswordResetRequests();
            const req = requests.find(function(r) { return r.id === requestId; });
            if (!req) {
                await notify.error('Solicitud no encontrada');
                return;
            }

            resetRequestIdActual = requestId;
            document.getElementById('reset-cuenta-info').textContent = 
                'Aprobar restablecimiento para: ' + req.displayName + ' (' + req.email + ')';
            document.getElementById('form-aprobar-reset').reset();
            document.getElementById('modal-aprobar-reset').classList.add('active');
        }

        function cerrarModalAprobarReset() {
            document.getElementById('modal-aprobar-reset').classList.remove('active');
            resetRequestIdActual = null;
        }

        async function confirmarAprobarReset(event) {
            event.preventDefault();

            const nuevaPassword = document.getElementById('nueva-password-reset').value;
            const confirmarPassword = document.getElementById('confirmar-password-reset').value;

            if (nuevaPassword !== confirmarPassword) {
                notify.error('Las contrase帽as no coinciden');
                return;
            }

            if (nuevaPassword.length < 4) {
                notify.error('La contrase帽a debe tener al menos 4 caracteres');
                return;
            }

            const result = auth.approvePasswordReset(resetRequestIdActual, nuevaPassword);

            if (result.success) {
                await notify.alert(result.message + '\n\nNueva contrase帽a: ' + nuevaPassword, 'success');
                cerrarModalAprobarReset();
                cargarRestablecimientos();
            } else {
                notify.error(result.message);
            }
        }

        async function abrirModalRechazarReset(requestId) {
            const requests = auth.getPasswordResetRequests();
            const req = requests.find(function(r) { return r.id === requestId; });
            if (!req) {
                await notify.error('Solicitud no encontrada');
                return;
            }

            resetRequestIdActual = requestId;
            document.getElementById('reset-cuenta-info-rechazar').textContent = 
                'Rechazar restablecimiento para: ' + req.displayName + ' (' + req.email + ')';
            document.getElementById('form-rechazar-reset').reset();
            document.getElementById('modal-rechazar-reset').classList.add('active');
        }

        function cerrarModalRechazarReset() {
            document.getElementById('modal-rechazar-reset').classList.remove('active');
            resetRequestIdActual = null;
        }

        async function confirmarRechazarReset(event) {
            event.preventDefault();

            const motivo = document.getElementById('motivo-rechazo-reset').value || 'Sin motivo especificado';

            const result = auth.rejectPasswordReset(resetRequestIdActual, motivo);

            if (result.success) {
                notify.success(result.message);
                cerrarModalRechazarReset();
                cargarRestablecimientos();
            } else {
                notify.error(result.message);
            }
        }

        async function verDetalleReset(requestId) {
            const requests = auth.getPasswordResetRequests();
            const req = requests.find(function(r) { return r.id === requestId; });
            if (!req) {
                await notify.error('Solicitud no encontrada');
                return;
            }

            let detalles = '=== DETALLES DE SOLICITUD DE RESTABLECIMIENTO ===\n\n';
            detalles += ' ID: ' + req.id + '\n';
            detalles += ' Cuenta: ' + req.displayName + '\n';
            detalles += ' Email: ' + req.email + '\n';
            detalles += ' Tipo: ' + (req.type === 'empresa' ? 'Empresa' : 'Usuario') + '\n';
            detalles += ' Fecha Solicitud: ' + new Date(req.createdAt).toLocaleString() + '\n';
            detalles += ' Estado: ' + req.status.toUpperCase() + '\n';
            
            if (req.tempPassword) {
                detalles += '\n Contrase帽a Temporal: ' + req.tempPassword;
            }
            
            if (req.motivoRechazo) {
                detalles += '\n\n Motivo Rechazo: ' + req.motivoRechazo;
            }
            
            if (req.adminDecisionAt) {
                detalles += '\n Fecha Decisi贸n: ' + new Date(req.adminDecisionAt).toLocaleString();
            }

            await notify.alert(detalles, 'info', 'Detalles de Solicitud');
        }

        // Cerrar modales de reset al hacer clic fuera
        document.getElementById('modal-aprobar-reset').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalAprobarReset();
            }
        });

        document.getElementById('modal-rechazar-reset').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalRechazarReset();
            }
        });

        // ===== FIN FUNCIONES DE RESTABLECIMIENTOS =====

        async function aprobar(empresaId) {
            const confirmed = await confirm('驴Est谩s seguro de que deseas aprobar esta empresa?');
            if (confirmed) {
                const result = auth.aprobarEmpresa(empresaId);
                if (result.success) {
                    notify.success(result.message);
                    cargarEstadisticas();
                    cargarPendientes();
                    cargarEmpresas();
                } else {
                    notify.error(result.message);
                }
            }
        }

        async function rechazar(empresaId) {
            const motivo = await prompt('Motivo del rechazo (opcional):');
            if (motivo !== null) {
                const result = auth.rechazarEmpresa(empresaId, motivo);
                if (result.success) {
                    notify.success(result.message);
                    cargarEstadisticas();
                    cargarPendientes();
                    cargarRechazadas();
                } else {
                    notify.error(result.message);
                }
            }
        }

        function verDetalles(id, tipo) {
            let cuenta = null;
            
            if (tipo === 'pendiente') {
                cuenta = auth.getEmpresasPendientes().find(function(e) { return e.id === id; });
            } else if (tipo === 'rechazada') {
                cuenta = auth.getEmpresasRechazadas().find(function(e) { return e.id === id; });
            } else if (tipo === 'empresa') {
                cuenta = auth.getEmpresas().find(function(e) { return e.id === id; });
            } else if (tipo === 'usuario') {
                cuenta = auth.getUsers().find(function(u) { return u.id === id; });
            }

            if (!cuenta) return;

            let html = '';
            
            if (tipo === 'usuario') {
                const saldo = cuenta.saldo || 0;
                const numTransacciones = (cuenta.transacciones || []).length;
                const estadoCuenta = cuenta.bloqueado ? '<span class="badge rejected">Bloqueado</span>' : '<span class="badge approved">Activo</span>';
                const rolBadge = cuenta.role === 'admin' 
                    ? '<span style="background: #e74c3c; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-weight: 600;">ADMIN</span>'
                    : '<span style="background: #4a90e2; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-weight: 600;">USUARIO</span>';

                html = '<div class="detail-row"><div class="detail-label">Nombre Completo:</div><div class="detail-value">' + cuenta.nombre + ' ' + (cuenta.apellido || '') + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Username:</div><div class="detail-value"><code style="background: #f0f0f0; padding: 0.3rem 0.6rem; border-radius: 5px;">' + cuenta.username + '</code></div></div>' +
                    '<div class="detail-row"><div class="detail-label">RUT:</div><div class="detail-value">' + (cuenta.rut || 'No especificado') + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Email:</div><div class="detail-value">' + cuenta.email + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Tel茅fono:</div><div class="detail-value">' + (cuenta.telefono || 'No especificado') + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Fecha de Nacimiento:</div><div class="detail-value">' + (cuenta.fechaNacimiento || 'No especificado') + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Rol:</div><div class="detail-value">' + rolBadge + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Estado:</div><div class="detail-value">' + estadoCuenta + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Saldo Actual:</div><div class="detail-value"><strong style="color: #27ae60; font-size: 1.3rem;">$' + saldo.toLocaleString('es-CL') + '</strong></div></div>' +
                    '<div class="detail-row"><div class="detail-label">Transacciones:</div><div class="detail-value">' + numTransacciones + ' registradas</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Fecha Registro:</div><div class="detail-value">' + new Date(cuenta.fechaRegistro).toLocaleString('es-CL') + '</div></div>';
                
                // Historial de transacciones con ID Tickets
                if (cuenta.transacciones && cuenta.transacciones.length > 0) {
                    html += '<div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e0e0e0;"><h4 style="margin: 0 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;"><i class="fas fa-receipt"></i> Historial de Transacciones</h4>';
                    html += '<div style="max-height: 300px; overflow-y: auto; background: #f9f9f9; padding: 1rem; border-radius: 8px;">';
                    
                    // Ordenar transacciones por fecha (m谩s reciente primero)
                    const transaccionesOrdenadas = [...cuenta.transacciones].sort((a, b) => {
                        return new Date(b.fecha) - new Date(a.fecha);
                    });
                    
                    transaccionesOrdenadas.forEach((transaccion, index) => {
                        const tipoIcon = transaccion.tipo === 'ingreso' || transaccion.tipo === 'deposito' ? '' : '';
                        const tipoColor = transaccion.tipo === 'ingreso' || transaccion.tipo === 'deposito' ? '#27ae60' : '#e74c3c';
                        const tipoTexto = transaccion.tipo === 'ingreso' ? 'Ingreso' : 
                                         transaccion.tipo === 'deposito' ? 'Dep贸sito' : 
                                         transaccion.tipo === 'egreso' ? 'Egreso' : 
                                         transaccion.tipo === 'retiro' ? 'Retiro' : 
                                         transaccion.tipo === 'puja' ? 'Puja' : 
                                         transaccion.tipo;
                        
                        html += '<div style="background: white; padding: 0.8rem; margin-bottom: 0.8rem; border-radius: 6px; border-left: 4px solid ' + tipoColor + ';">' +
                            '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">' +
                            '<div>' +
                            '<span style="background: ' + tipoColor + '; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">' + tipoIcon + ' ' + tipoTexto + '</span>' +
                            '<div style="margin-top: 0.3rem; font-size: 0.9rem; color: #666;">' +
                            '<strong>ID Ticket:</strong> <code style="background: #f0f0f0; padding: 0.2rem 0.5rem; border-radius: 4px; font-family: monospace; color: #e74c3c;">' + (transaccion.ticketId || transaccion.id || 'N/A') + '</code>' +
                            '</div>' +
                            '</div>' +
                            '<div style="text-align: right;">' +
                            '<div style="font-size: 1.1rem; font-weight: bold; color: ' + tipoColor + ';">$' + (transaccion.monto || 0).toLocaleString('es-CL') + '</div>' +
                            '<div style="font-size: 0.8rem; color: #999;">' + new Date(transaccion.fecha).toLocaleDateString('es-CL') + '</div>' +
                            '</div>' +
                            '</div>';
                        
                        if (transaccion.concepto || transaccion.descripcion) {
                            html += '<div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">' +
                                '<i class="fas fa-comment-alt" style="margin-right: 0.3rem;"></i>' + 
                                (transaccion.concepto || transaccion.descripcion) + 
                                '</div>';
                        }
                        
                        html += '</div>';
                    });
                    
                    html += '</div></div>';
                }
                
                // Direcci贸n de env铆o - Mejorada para mostrar siempre
                html += '<div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e0e0e0;"><h4 style="margin: 0 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;"><i class="fas fa-map-marker-alt"></i> Direcci贸n de Env铆o</h4>';
                
                if (cuenta.direccionEnvio && cuenta.direccionEnvio.direccion) {
                    html += '<div class="detail-row"><div class="detail-label">Direcci贸n:</div><div class="detail-value">' + cuenta.direccionEnvio.direccion + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">Comuna:</div><div class="detail-value">' + (cuenta.direccionEnvio.comuna || 'No especificada') + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">Ciudad:</div><div class="detail-value">' + (cuenta.direccionEnvio.ciudad || 'No especificada') + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">Regi贸n:</div><div class="detail-value">' + (cuenta.direccionEnvio.region || 'No especificada') + '</div></div>' +
                        '<div class="detail-row"><div class="detail-label">C贸digo Postal:</div><div class="detail-value">' + (cuenta.direccionEnvio.codigoPostal || 'No especificado') + '</div></div>';
                } else if (cuenta.direccion) {
                    // Si tiene direcci贸n pero no en el formato direccionEnvio
                    html += '<div class="detail-row"><div class="detail-label">Direcci贸n:</div><div class="detail-value">' + cuenta.direccion + '</div></div>';
                } else {
                    html += '<div class="detail-row"><div class="detail-label">Direcci贸n:</div><div class="detail-value"><em style="color: #999;">No registrada</em></div></div>';
                }
                
                html += '</div>';
            } else {
                // Informaci贸n de empresa
                const saldo = cuenta.saldo || 0;
                const transacciones = cuenta.transacciones || [];
                const ingresos = transacciones
                    .filter(t => t.tipo === 'ingreso' || t.tipo === 'deposito' || t.tipo === 'venta')
                    .reduce((sum, t) => sum + (t.monto || 0), 0);
                const egresos = transacciones
                    .filter(t => t.tipo === 'egreso' || t.tipo === 'retiro' || t.tipo === 'comision')
                    .reduce((sum, t) => sum + (t.monto || 0), 0);
                const numTransacciones = transacciones.length;
                const estadoCuenta = cuenta.bloqueado ? '<span class="badge rejected">Bloqueada</span>' : '<span class="badge approved">Activa</span>';
                
                html = '<div style="margin-bottom: 1.5rem;"><h4 style="margin: 0 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;">Informaci贸n General</h4>' +
                    '<div class="detail-row"><div class="detail-label">Raz贸n Social:</div><div class="detail-value"><strong>' + cuenta.razonSocial + '</strong></div></div>' +
                    '<div class="detail-row"><div class="detail-label">Username:</div><div class="detail-value"><code style="background: #f0f0f0; padding: 0.3rem 0.6rem; border-radius: 5px;">' + cuenta.username + '</code></div></div>' +
                    '<div class="detail-row"><div class="detail-label">RUT Empresa:</div><div class="detail-value">' + cuenta.rut + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Email:</div><div class="detail-value">' + cuenta.email + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Tel茅fono:</div><div class="detail-value">' + (cuenta.telefono || 'No especificado') + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Sitio Web:</div><div class="detail-value">' + (cuenta.sitioWeb ? '<a href="' + cuenta.sitioWeb + '" target="_blank" style="color: #4a90e2;">' + cuenta.sitioWeb + '</a>' : 'No especificado') + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Estado:</div><div class="detail-value">' + estadoCuenta + '</div></div>' +
                    '<div class="detail-row"><div class="detail-label">Fecha Registro:</div><div class="detail-value">' + new Date(cuenta.fechaRegistro).toLocaleString('es-CL') + '</div></div>';
                
                if (cuenta.fechaAprobacion) {
                    html += '<div class="detail-row"><div class="detail-label">Fecha Aprobaci贸n:</div><div class="detail-value">' + new Date(cuenta.fechaAprobacion).toLocaleString('es-CL') + '</div></div>';
                }
                
                if (cuenta.fechaRechazo) {
                    html += '<div class="detail-row"><div class="detail-label">Fecha Rechazo:</div><div class="detail-value">' + new Date(cuenta.fechaRechazo).toLocaleString('es-CL') + '</div></div>';
                    html += '<div class="detail-row"><div class="detail-label">Motivo Rechazo:</div><div class="detail-value">' + (cuenta.motivoRechazo || 'No especificado') + '</div></div>';
                }
                
                html += '</div>';
                
                // Secci贸n de direcci贸n
                html += '<div style="margin-bottom: 1.5rem;"><h4 style="margin: 0 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;">Ubicaci贸n</h4>' +
                    '<div class="detail-row"><div class="detail-label">Direcci贸n:</div><div class="detail-value">' + (cuenta.direccion || 'No especificada') + '</div></div>';
                
                if (cuenta.comuna) {
                    html += '<div class="detail-row"><div class="detail-label">Comuna:</div><div class="detail-value">' + cuenta.comuna + '</div></div>';
                }
                if (cuenta.ciudad) {
                    html += '<div class="detail-row"><div class="detail-label">Ciudad:</div><div class="detail-value">' + cuenta.ciudad + '</div></div>';
                }
                if (cuenta.region) {
                    html += '<div class="detail-row"><div class="detail-label">Regi贸n:</div><div class="detail-value">' + cuenta.region + '</div></div>';
                }
                
                html += '</div>';
                
                // Secci贸n financiera
                html += '<div style="margin-bottom: 1.5rem;"><h4 style="margin: 0 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;">Informaci贸n Financiera</h4>' +
                    '<div class="detail-row"><div class="detail-label">Saldo Actual:</div><div class="detail-value"><strong style="color: #27ae60; font-size: 1.3rem;">$' + saldo.toLocaleString('es-CL') + '</strong></div></div>' +
                    '<div class="detail-row"><div class="detail-label">Total Ingresos:</div><div class="detail-value"><strong style="color: #27ae60; font-size: 1.1rem;">$' + ingresos.toLocaleString('es-CL') + '</strong></div></div>' +
                    '<div class="detail-row"><div class="detail-label">Total Egresos:</div><div class="detail-value"><strong style="color: #e74c3c; font-size: 1.1rem;">$' + egresos.toLocaleString('es-CL') + '</strong></div></div>' +
                    '<div class="detail-row"><div class="detail-label">Balance Neto:</div><div class="detail-value"><strong style="color: ' + ((ingresos - egresos) >= 0 ? '#27ae60' : '#e74c3c') + '; font-size: 1.1rem;">$' + (ingresos - egresos).toLocaleString('es-CL') + '</strong></div></div>' +
                    '<div class="detail-row"><div class="detail-label">Transacciones Registradas:</div><div class="detail-value">' + numTransacciones + ' operaciones</div></div>' +
                    '</div>';
                
                // Secci贸n de documentos legales
                if (cuenta.documentosLegales) {
                    html += '<div style="margin-bottom: 1.5rem;"><h4 style="margin: 0 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;"><i class="fas fa-file-contract"></i> Documentos Legales</h4>';
                    
                    if (cuenta.documentosLegales.inicioActividades) {
                        const doc = cuenta.documentosLegales.inicioActividades;
                        html += '<div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem; border-left: 4px solid #27ae60;">' +
                            '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                            '<div>' +
                            '<div style="font-weight: 600; color: #333; margin-bottom: 0.3rem;"><i class="fas fa-file-pdf" style="color: #e74c3c; margin-right: 0.5rem;"></i>Inicio de Actividades (SII)</div>' +
                            '<div style="font-size: 0.85rem; color: #666;">' + doc.nombre + '  ' + (doc.tama帽o / 1024).toFixed(2) + ' KB</div>' +
                            '<div style="font-size: 0.8rem; color: #999;">Subido: ' + new Date(doc.fechaSubida).toLocaleDateString('es-CL') + '</div>' +
                            '</div>' +
                            '<button onclick="descargarDocumento(\'' + cuenta.id + '\', \'inicioActividades\', \'' + tipo + '\')" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">' +
                            '<i class="fas fa-download"></i> Descargar' +
                            '</button>' +
                            '</div></div>';
                    }
                    
                    if (cuenta.documentosLegales.certificadoVigencia) {
                        const doc = cuenta.documentosLegales.certificadoVigencia;
                        html += '<div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem; border-left: 4px solid #27ae60;">' +
                            '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                            '<div>' +
                            '<div style="font-weight: 600; color: #333; margin-bottom: 0.3rem;"><i class="fas fa-file-pdf" style="color: #e74c3c; margin-right: 0.5rem;"></i>Certificado de Vigencia</div>' +
                            '<div style="font-size: 0.85rem; color: #666;">' + doc.nombre + '  ' + (doc.tama帽o / 1024).toFixed(2) + ' KB</div>' +
                            '<div style="font-size: 0.8rem; color: #999;">Subido: ' + new Date(doc.fechaSubida).toLocaleDateString('es-CL') + '</div>' +
                            '</div>' +
                            '<button onclick="descargarDocumento(\'' + cuenta.id + '\', \'certificadoVigencia\', \'' + tipo + '\')" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">' +
                            '<i class="fas fa-download"></i> Descargar' +
                            '</button>' +
                            '</div></div>';
                    }
                    
                    if (cuenta.documentosLegales.estatutos) {
                        const doc = cuenta.documentosLegales.estatutos;
                        html += '<div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem; border-left: 4px solid #3498db;">' +
                            '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                            '<div>' +
                            '<div style="font-weight: 600; color: #333; margin-bottom: 0.3rem;"><i class="fas fa-file-pdf" style="color: #e74c3c; margin-right: 0.5rem;"></i>Estatutos de la Empresa</div>' +
                            '<div style="font-size: 0.85rem; color: #666;">' + doc.nombre + '  ' + (doc.tama帽o / 1024).toFixed(2) + ' KB</div>' +
                            '<div style="font-size: 0.8rem; color: #999;">Subido: ' + new Date(doc.fechaSubida).toLocaleDateString('es-CL') + '</div>' +
                            '</div>' +
                            '<button onclick="descargarDocumento(\'' + cuenta.id + '\', \'estatutos\', \'' + tipo + '\')" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">' +
                            '<i class="fas fa-download"></i> Descargar' +
                            '</button>' +
                            '</div></div>';
                    }
                    
                    html += '</div>';
                } else {
                    html += '<div style="margin-bottom: 1.5rem;"><h4 style="margin: 0 0 1rem 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;"><i class="fas fa-file-contract"></i> Documentos Legales</h4>' +
                        '<div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border: 1px solid #ffc107;">' +
                        '<p style="margin: 0; color: #856404;"><i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>No se han adjuntado documentos legales</p>' +
                        '</div></div>';
                }
            }
        
        // Funci贸n para descargar documentos
        function descargarDocumento(empresaId, tipoDocumento, origen) {
            let empresas = [];
            
            if (origen === 'pendiente') {
                empresas = auth.getEmpresasPendientes();
            } else if (origen === 'rechazada') {
                empresas = auth.getEmpresasRechazadas();
            } else {
                empresas = auth.getEmpresas();
            }
            
            const empresa = empresas.find(e => e.id === empresaId);
            
            if (!empresa || !empresa.documentosLegales || !empresa.documentosLegales[tipoDocumento]) {
                notify.error('Documento no encontrado');
                return;
            }
            
            const doc = empresa.documentosLegales[tipoDocumento];
            
            // Crear un enlace temporal para descargar
            const link = document.createElement('a');
            link.href = doc.contenido;
            link.download = doc.nombre;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            notify.success('Descargando documento: ' + doc.nombre);
        }
        
        // Modal para ver documentos de empresa
        function verDocumentosEmpresa(empresaId, origen) {
            let empresas = [];
            
            if (origen === 'pendiente') {
                empresas = auth.getEmpresasPendientes();
            } else if (origen === 'rechazada') {
                empresas = auth.getEmpresasRechazadas();
            } else {
                empresas = auth.getEmpresas();
            }
            
            const empresa = empresas.find(e => e.id === empresaId);
            
            if (!empresa) {
                notify.error('Empresa no encontrada');
                return;
            }
            
            if (!empresa.documentosLegales) {
                notify.error('Esta empresa no tiene documentos adjuntados');
                return;
            }
            
            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.style.zIndex = '10000';
            
            let docsHtml = '';
            
            // Documento: Inicio de Actividades
            if (empresa.documentosLegales.inicioActividades) {
                const doc = empresa.documentosLegales.inicioActividades;
                docsHtml += '<div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem; border-left: 5px solid #27ae60;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">' +
                    '<div style="flex: 1;">' +
                    '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">' +
                    '<i class="fas fa-file-pdf" style="font-size: 2rem; color: #e74c3c;"></i>' +
                    '<div>' +
                    '<h4 style="margin: 0; color: #333; font-size: 1.1rem;">Certificado de Inicio de Actividades (SII)</h4>' +
                    '<p style="margin: 0.3rem 0 0 0; color: #666; font-size: 0.9rem;">' + doc.nombre + '</p>' +
                    '</div>' +
                    '</div>' +
                    '<div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #666;">' +
                    '<span><i class="fas fa-weight"></i> ' + (doc.tama帽o / 1024).toFixed(2) + ' KB</span>' +
                    '<span><i class="fas fa-calendar"></i> ' + new Date(doc.fechaSubida).toLocaleDateString('es-CL') + '</span>' +
                    '</div>' +
                    '</div>' +
                    '<button onclick="descargarDocumento(\'' + empresaId + '\', \'inicioActividades\', \'' + origen + '\')" style="background: var(--primary); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; min-width: 120px;">' +
                    '<i class="fas fa-download"></i> Descargar' +
                    '</button>' +
                    '</div>' +
                    '</div>';
            }
            
            // Documento: Certificado de Vigencia
            if (empresa.documentosLegales.certificadoVigencia) {
                const doc = empresa.documentosLegales.certificadoVigencia;
                docsHtml += '<div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem; border-left: 5px solid #27ae60;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">' +
                    '<div style="flex: 1;">' +
                    '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">' +
                    '<i class="fas fa-file-pdf" style="font-size: 2rem; color: #e74c3c;"></i>' +
                    '<div>' +
                    '<h4 style="margin: 0; color: #333; font-size: 1.1rem;">Certificado de Vigencia</h4>' +
                    '<p style="margin: 0.3rem 0 0 0; color: #666; font-size: 0.9rem;">' + doc.nombre + '</p>' +
                    '</div>' +
                    '</div>' +
                    '<div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #666;">' +
                    '<span><i class="fas fa-weight"></i> ' + (doc.tama帽o / 1024).toFixed(2) + ' KB</span>' +
                    '<span><i class="fas fa-calendar"></i> ' + new Date(doc.fechaSubida).toLocaleDateString('es-CL') + '</span>' +
                    '</div>' +
                    '</div>' +
                    '<button onclick="descargarDocumento(\'' + empresaId + '\', \'certificadoVigencia\', \'' + origen + '\')" style="background: var(--primary); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; min-width: 120px;">' +
                    '<i class="fas fa-download"></i> Descargar' +
                    '</button>' +
                    '</div>' +
                    '</div>';
            }
            
            // Documento: Estatutos (Opcional)
            if (empresa.documentosLegales.estatutos) {
                const doc = empresa.documentosLegales.estatutos;
                docsHtml += '<div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem; border-left: 5px solid #3498db;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">' +
                    '<div style="flex: 1;">' +
                    '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">' +
                    '<i class="fas fa-file-pdf" style="font-size: 2rem; color: #e74c3c;"></i>' +
                    '<div>' +
                    '<h4 style="margin: 0; color: #333; font-size: 1.1rem;">Estatutos de la Empresa <span style="color: #3498db; font-size: 0.8rem;">(Opcional)</span></h4>' +
                    '<p style="margin: 0.3rem 0 0 0; color: #666; font-size: 0.9rem;">' + doc.nombre + '</p>' +
                    '</div>' +
                    '</div>' +
                    '<div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #666;">' +
                    '<span><i class="fas fa-weight"></i> ' + (doc.tama帽o / 1024).toFixed(2) + ' KB</span>' +
                    '<span><i class="fas fa-calendar"></i> ' + new Date(doc.fechaSubida).toLocaleDateString('es-CL') + '</span>' +
                    '</div>' +
                    '</div>' +
                    '<button onclick="descargarDocumento(\'' + empresaId + '\', \'estatutos\', \'' + origen + '\')" style="background: var(--primary); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; min-width: 120px;">' +
                    '<i class="fas fa-download"></i> Descargar' +
                    '</button>' +
                    '</div>' +
                    '</div>';
            }
            
            modal.innerHTML = '<div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">' +
                '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 3px solid var(--primary);">' +
                '<h2 style="margin: 0; color: var(--primary);">' +
                '<i class="fas fa-file-contract"></i> Documentos Legales' +
                '</h2>' +
                '<button onclick="this.closest(\'.modal\').remove()" style="background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #999; padding: 0; width: 40px; height: 40px;">' +
                '<i class="fas fa-times"></i>' +
                '</button>' +
                '</div>' +
                '<div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #2196f3;">' +
                '<p style="margin: 0; color: #1565c0;"><strong><i class="fas fa-building"></i> ' + empresa.razonSocial + '</strong></p>' +
                '<p style="margin: 0.3rem 0 0 0; color: #1976d2; font-size: 0.9rem;"><i class="fas fa-id-card"></i> RUT: ' + empresa.rut + '</p>' +
                '</div>' +
                docsHtml +
                '<div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e0e0e0; text-align: center;">' +
                '<button onclick="this.closest(\'.modal\').remove()" style="background: #e0e0e0; color: #333; border: none; padding: 0.8rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600;">' +
                '<i class="fas fa-times"></i> Cerrar' +
                '</button>' +
                '</div>' +
                '</div>';
            
            document.body.appendChild(modal);
            
            // Cerrar al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('modal-detalles').classList.add('active');
        }

        function cerrarModal() {
            document.getElementById('modal-detalles').classList.remove('active');
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('modal-detalles').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModal();
            }
        });

        // Variables globales para el modal de contrase帽a
        let passwordCuentaId = null;
        let passwordCuentaTipo = null;

        function abrirModalPassword(id, tipo) {
            passwordCuentaId = id;
            passwordCuentaTipo = tipo;

            let cuenta = null;
            if (tipo === 'usuario') {
                cuenta = auth.getUsers().find(function(u) { return u.id === id; });
                if (cuenta) {
                    document.getElementById('password-cuenta-nombre').textContent = 
                        'Cambiar contrase帽a de: ' + cuenta.nombre + ' ' + cuenta.apellido + ' (' + cuenta.username + ')';
                }
            } else {
                cuenta = auth.getEmpresas().find(function(e) { return e.id === id; });
                if (cuenta) {
                    document.getElementById('password-cuenta-nombre').textContent = 
                        'Cambiar contrase帽a de: ' + cuenta.razonSocial + ' (' + cuenta.username + ')';
                }
            }

            document.getElementById('nueva-password').value = '';
            document.getElementById('confirmar-password').value = '';
            document.getElementById('modal-password').classList.add('active');
        }

        function cerrarModalPassword() {
            document.getElementById('modal-password').classList.remove('active');
            passwordCuentaId = null;
            passwordCuentaTipo = null;
        }

        async function cambiarPassword(event) {
            event.preventDefault();

            const nuevaPassword = document.getElementById('nueva-password').value;
            const confirmarPassword = document.getElementById('confirmar-password').value;

            if (nuevaPassword !== confirmarPassword) {
                notify.error('Las contrase帽as no coinciden');
                return;
            }

            if (nuevaPassword.length < 4) {
                notify.error('La contrase帽a debe tener al menos 4 caracteres');
                return;
            }

            let result;
            if (passwordCuentaTipo === 'usuario') {
                result = auth.cambiarPasswordUsuario(passwordCuentaId, nuevaPassword);
            } else {
                result = auth.cambiarPasswordEmpresa(passwordCuentaId, nuevaPassword);
            }

            if (result.success) {
                notify.success(result.message);
                cerrarModalPassword();
            } else {
                notify.error(result.message);
            }
        }

        // Funci贸n eliminarCuenta movida arriba en el c贸digo (l铆nea ~1671) para evitar duplicados

        // Cerrar modal de password al hacer clic fuera
        document.getElementById('modal-password').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalPassword();
            }
        });

        // ===== FUNCIONES DE GESTIN FINANCIERA =====

        function abrirModalGestionFinanzas(tipo) {
            console.log('Abriendo modal de gesti贸n financiera, tipo:', tipo);
            try {
                tipoCuentasActual = tipo;
                const tituloElement = document.getElementById('tipo-cuentas-titulo');
                if (!tituloElement) {
                    console.error('Elemento tipo-cuentas-titulo no encontrado');
                    return;
                }
                tituloElement.textContent = tipo === 'user' ? 'Usuarios' : 'Empresas';
                cargarCuentasFinanzas(tipo);
                actualizarResumenFinanciero();
                const modalElement = document.getElementById('modal-gestion-finanzas');
                if (!modalElement) {
                    console.error('Elemento modal-gestion-finanzas no encontrado');
                    return;
                }
                modalElement.style.display = 'flex';
                console.log('Modal abierto exitosamente');
            } catch (error) {
                console.error('Error al abrir modal de gesti贸n financiera:', error);
            }
        }

        function cerrarModalGestionFinanzas() {
            document.getElementById('modal-gestion-finanzas').style.display = 'none';
        }

        function cargarCuentasFinanzas(tipo) {
            const tbody = document.getElementById('tabla-cuentas-finanzas');
            let cuentas = [];

            if (tipo === 'user') {
                cuentas = auth.getUsers().filter(function(u) { return u.role !== 'admin'; }); // Excluir admin
            } else {
                cuentas = auth.getEmpresas();
            }

            if (cuentas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: #999;">No hay cuentas registradas</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            cuentas.forEach(function(cuenta) {
                const nombre = tipo === 'user' 
                    ? cuenta.nombre + ' ' + cuenta.apellido 
                    : cuenta.razonSocial;
                const saldo = cuenta.saldo || 0;
                const saldoFormateado = new Intl.NumberFormat('es-CL', {
                    style: 'currency',
                    currency: 'CLP',
                    minimumFractionDigits: 0
                }).format(saldo);

                const row = document.createElement('tr');
                row.innerHTML = '<td>' + nombre + '</td>' +
                    '<td>' + cuenta.email + '</td>' +
                    '<td><strong style="color: var(--primary); font-size: 1.1rem;">' + saldoFormateado + '</strong></td>' +
                    '<td>' +
                    '<button class="btn-action btn-edit" onclick=\'abrirModalModificarSaldo(' + JSON.stringify(cuenta).replace(/'/g, "\\'") + ', "' + tipo + '")\'>' +
                    '<i class="fas fa-edit"></i> Modificar' +
                    '</button>' +
                    '</td>';
                tbody.appendChild(row);
            });
        }

        function abrirModalModificarSaldo(cuenta, tipo) {
            cuentaSeleccionada = { ...cuenta, tipo: tipo };
            
            const nombre = tipo === 'user' 
                ? cuenta.nombre + ' ' + cuenta.apellido 
                : cuenta.razonSocial;
            
            const saldo = cuenta.saldo || 0;
            const saldoFormateado = new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                minimumFractionDigits: 0
            }).format(saldo);

            document.getElementById('saldo-cuenta-nombre').textContent = nombre;
            document.getElementById('saldo-actual-display').textContent = saldoFormateado;
            document.getElementById('form-modificar-saldo').reset();
            
            document.getElementById('modal-modificar-saldo').style.display = 'flex';
        }

        function cerrarModalModificarSaldo() {
            document.getElementById('modal-modificar-saldo').style.display = 'none';
            cuentaSeleccionada = null;
        }

        function modificarSaldoCuenta(event) {
            event.preventDefault();

            if (!cuentaSeleccionada) {
                alert('Error: No hay cuenta seleccionada');
                return;
            }

            const form = event.target;
            const tipoOperacion = form['tipo-operacion'].value;
            let monto = parseInt(form['monto-operacion'].value);
            const motivo = form['motivo-operacion'].value;

            // Si es egreso, hacer el monto negativo
            if (tipoOperacion === 'egreso') {
                monto = -monto;
            }

            const result = auth.modificarSaldo(cuentaSeleccionada.id, monto, motivo, cuentaSeleccionada.tipo);

            if (result.success) {
                alert(result.message + '\nNuevo saldo: ' + new Intl.NumberFormat('es-CL', {
                    style: 'currency',
                    currency: 'CLP',
                    minimumFractionDigits: 0
                }).format(result.nuevoSaldo));
                
                cerrarModalModificarSaldo();
                cargarCuentasFinanzas(tipoCuentasActual);
                actualizarResumenFinanciero();
            } else {
                alert('Error: ' + result.message);
            }
        }

        function actualizarResumenFinanciero() {
            const usuarios = auth.getUsers().filter(function(u) { return u.role !== 'admin'; });
            const empresas = auth.getEmpresas();

            let totalUsuarios = 0;
            let totalTransacciones = 0;
            usuarios.forEach(function(u) {
                totalUsuarios += (u.saldo || 0);
                totalTransacciones += (u.transacciones || []).length;
            });

            let totalEmpresas = 0;
            empresas.forEach(function(e) {
                totalEmpresas += (e.saldo || 0);
                totalTransacciones += (e.transacciones || []).length;
            });

            const totalCirculacion = totalUsuarios + totalEmpresas;

            // Contar subastas activas
            const subastas = JSON.parse(localStorage.getItem('nexos_subastas') || '[]');
            const subastasActivas = subastas.filter(function(s) { 
                return s.estado === 'activa' && new Date(s.fechaFin) > new Date(); 
            }).length;

            const formatear = function(monto) {
                return new Intl.NumberFormat('es-CL', {
                    style: 'currency',
                    currency: 'CLP',
                    minimumFractionDigits: 0
                }).format(monto);
            };

            document.getElementById('total-usuarios-saldo').textContent = formatear(totalUsuarios);
            document.getElementById('total-empresas-saldo').textContent = formatear(totalEmpresas);
            document.getElementById('total-circulacion').textContent = formatear(totalCirculacion);
            document.getElementById('total-usuarios-count').textContent = usuarios.length;
            document.getElementById('total-empresas-count').textContent = empresas.length;
            document.getElementById('total-transacciones').textContent = totalTransacciones;
            document.getElementById('total-subastas-activas').textContent = subastasActivas;
            document.getElementById('total-subastas-count').textContent = subastasActivas;
        }

        function actualizarDashboardFinanciero() {
            actualizarResumenFinanciero();
            notify.success('Dashboard actualizado correctamente');
        }

        // ===== FUNCIONES DE AUDITORA =====
        
        function mostrarAuditoria() {
            document.getElementById('auditoria-section').style.display = 'block';
            cargarAuditoria();
            
            // Scroll suave a la secci贸n
            document.getElementById('auditoria-section').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function ocultarAuditoria() {
            document.getElementById('auditoria-section').style.display = 'none';
        }

        function cargarAuditoria() {
            const eventos = [];
            
            // Recopilar todas las transacciones de usuarios
            const usuarios = JSON.parse(localStorage.getItem('nexos_users') || '[]');
            usuarios.forEach(function(usuario) {
                if (usuario.transacciones && usuario.transacciones.length > 0) {
                    usuario.transacciones.forEach(function(trans) {
                        eventos.push({
                            fecha: trans.fecha,
                            tipo: 'transaction',
                            entidad: usuario.username || usuario.nombre,
                            descripcion: trans.descripcion || trans.concepto || 'Transacci贸n',
                            monto: trans.monto,
                            estado: trans.tipo,
                            detalles: {
                                saldoAnterior: trans.saldoAnterior,
                                saldoFinal: trans.saldoFinal,
                                numeroTransaccion: trans.numeroTransaccion
                            }
                        });
                    });
                }

                // Actividad de seguridad
                if (usuario.actividadReciente && usuario.actividadReciente.length > 0) {
                    usuario.actividadReciente.forEach(function(act) {
                        eventos.push({
                            fecha: act.fecha,
                            tipo: 'user_action',
                            entidad: usuario.username || usuario.nombre,
                            descripcion: act.descripcion,
                            monto: null,
                            estado: act.tipo,
                            detalles: {
                                dispositivo: act.dispositivo,
                                ubicacion: act.ubicacion,
                                ip: act.ip
                            }
                        });
                    });
                }
            });

            // Recopilar transacciones de empresas
            const empresas = JSON.parse(localStorage.getItem('nexos_empresas') || '[]');
            empresas.forEach(function(empresa) {
                if (empresa.transacciones && empresa.transacciones.length > 0) {
                    empresa.transacciones.forEach(function(trans) {
                        eventos.push({
                            fecha: trans.fecha,
                            tipo: 'transaction',
                            entidad: empresa.nombreEmpresa || empresa.razonSocial,
                            descripcion: trans.descripcion || trans.concepto || 'Transacci贸n',
                            monto: trans.monto,
                            estado: trans.tipo,
                            detalles: {
                                saldoAnterior: trans.saldoAnterior,
                                saldoFinal: trans.saldoFinal,
                                numeroTransaccion: trans.numeroTransaccion
                            }
                        });
                    });
                }

                // Actividad de seguridad de empresas
                if (empresa.actividadReciente && empresa.actividadReciente.length > 0) {
                    empresa.actividadReciente.forEach(function(act) {
                        eventos.push({
                            fecha: act.fecha,
                            tipo: 'user_action',
                            entidad: empresa.nombreEmpresa || empresa.razonSocial,
                            descripcion: act.descripcion,
                            monto: null,
                            estado: act.tipo,
                            detalles: {
                                dispositivo: act.dispositivo,
                                ubicacion: act.ubicacion,
                                ip: act.ip
                            }
                        });
                    });
                }
            });

            // Recopilar eventos de subastas
            const subastas = JSON.parse(localStorage.getItem('nexos_subastas') || '[]');
            subastas.forEach(function(subasta) {
                // Evento de creaci贸n
                eventos.push({
                    fecha: subasta.fechaCreacion || subasta.fechaInicio,
                    tipo: 'auction',
                    entidad: subasta.empresaNombre || 'Sistema',
                    descripcion: 'Subasta creada: ' + subasta.titulo,
                    monto: subasta.precioInicial,
                    estado: 'created',
                    detalles: {
                        id: subasta.id,
                        estado: subasta.estado
                    }
                });

                // Eventos de pujas
                if (subasta.pujas && subasta.pujas.length > 0) {
                    subasta.pujas.forEach(function(puja) {
                        eventos.push({
                            fecha: puja.fecha,
                            tipo: 'auction',
                            entidad: puja.usuario,
                            descripcion: 'Puja en: ' + subasta.titulo,
                            monto: puja.monto,
                            estado: 'bid',
                            detalles: {
                                subasta: subasta.id,
                                subastaEstado: subasta.estado
                            }
                        });
                    });
                }

                // Evento de finalizaci贸n
                if (subasta.estado === 'finalizada') {
                    eventos.push({
                        fecha: subasta.fechaFin,
                        tipo: 'auction',
                        entidad: subasta.empresaNombre || 'Sistema',
                        descripcion: 'Subasta finalizada: ' + subasta.titulo,
                        monto: subasta.precioActual,
                        estado: 'finished',
                        detalles: {
                            id: subasta.id,
                            ganador: subasta.pujas && subasta.pujas.length > 0 
                                ? subasta.pujas[subasta.pujas.length - 1].usuario 
                                : 'Sin ganador'
                        }
                    });
                }
            });

            // Ordenar por fecha descendente (m谩s reciente primero)
            eventos.sort(function(a, b) {
                return new Date(b.fecha) - new Date(a.fecha);
            });

            // Actualizar estad铆sticas
            const ahora = new Date();
            const hace24h = new Date(ahora.getTime() - 24 * 60 * 60 * 1000);
            const hace7dias = new Date(ahora.getTime() - 7 * 24 * 60 * 60 * 1000);
            const hace30dias = new Date(ahora.getTime() - 30 * 24 * 60 * 60 * 1000);

            const eventos24h = eventos.filter(function(e) { return new Date(e.fecha) >= hace24h; }).length;
            const eventosSemana = eventos.filter(function(e) { return new Date(e.fecha) >= hace7dias; }).length;
            const eventosMes = eventos.filter(function(e) { return new Date(e.fecha) >= hace30dias; }).length;

            document.getElementById('total-eventos-audit').textContent = eventos.length;
            document.getElementById('eventos-24h').textContent = eventos24h;
            document.getElementById('eventos-semana').textContent = eventosSemana;
            document.getElementById('eventos-mes').textContent = eventosMes;

            // Renderizar tabla
            renderizarTablaAuditoria(eventos);
        }

        function renderizarTablaAuditoria(eventos) {
            const tbody = document.getElementById('tabla-auditoria');
            
            if (eventos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 3rem; color: #999;">No hay eventos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            eventos.forEach(function(evento) {
                const fecha = new Date(evento.fecha);
                const fechaFormateada = fecha.toLocaleDateString('es-CL', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                }) + '<br>' + fecha.toLocaleTimeString('es-CL', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Icono y color seg煤n tipo
                const tipoConfig = {
                    'transaction': { icon: 'fa-exchange-alt', color: '#4a90e2', label: 'Transacci贸n' },
                    'user_action': { icon: 'fa-user-edit', color: '#27ae60', label: 'Usuario' },
                    'admin_action': { icon: 'fa-user-shield', color: '#e74c3c', label: 'Admin' },
                    'auction': { icon: 'fa-gavel', color: '#9b59b6', label: 'Subasta' },
                    'security': { icon: 'fa-shield-alt', color: '#f39c12', label: 'Seguridad' }
                };

                const config = tipoConfig[evento.tipo] || { icon: 'fa-circle', color: '#666', label: 'Otro' };

                // Estado
                const estadoConfig = {
                    'ingreso': { color: '#27ae60', icon: 'fa-arrow-up' },
                    'egreso': { color: '#e74c3c', icon: 'fa-arrow-down' },
                    'retiro': { color: '#e67e22', icon: 'fa-money-bill-wave' },
                    'created': { color: '#4a90e2', icon: 'fa-plus' },
                    'bid': { color: '#9b59b6', icon: 'fa-gavel' },
                    'finished': { color: '#27ae60', icon: 'fa-check' },
                    'deposito_webpay': { color: '#27ae60', icon: 'fa-credit-card' }
                };

                const estadoConf = estadoConfig[evento.estado] || { color: '#666', icon: 'fa-circle' };

                const montoHTML = evento.monto !== null 
                    ? '<span style="color: ' + (evento.monto >= 0 ? '#27ae60' : '#e74c3c') + '; font-weight: 700;">' +
                      new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 }).format(Math.abs(evento.monto)) +
                      '</span>'
                    : '-';

                const row = document.createElement('tr');
                row.style.borderLeft = '3px solid ' + config.color;
                row.innerHTML = 
                    '<td style="font-size: 0.85rem;">' + fechaFormateada + '</td>' +
                    '<td>' +
                        '<div style="display: flex; align-items: center; gap: 0.5rem;">' +
                            '<i class="fas ' + config.icon + '" style="color: ' + config.color + ';"></i>' +
                            '<span style="font-weight: 600; font-size: 0.9rem;">' + config.label + '</span>' +
                        '</div>' +
                    '</td>' +
                    '<td style="font-weight: 600;">' + evento.entidad + '</td>' +
                    '<td style="font-size: 0.95rem;">' + evento.descripcion + '</td>' +
                    '<td>' + montoHTML + '</td>' +
                    '<td>' +
                        '<span style="background: ' + estadoConf.color + '22; color: ' + estadoConf.color + '; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem;">' +
                            '<i class="fas ' + estadoConf.icon + '"></i> ' +
                            evento.estado +
                        '</span>' +
                    '</td>';
                
                tbody.appendChild(row);
            });
        }

        function filtrarAuditoria() {
            const filtro = document.getElementById('filtro-tipo-auditoria').value;
            const filas = document.querySelectorAll('#tabla-auditoria tr');
            
            filas.forEach(function(fila) {
                if (filtro === 'all') {
                    fila.style.display = '';
                } else {
                    const tipoTexto = fila.querySelector('td:nth-child(2) span');
                    if (tipoTexto) {
                        const tipoMap = {
                            'Transacci贸n': 'transaction',
                            'Usuario': 'user_action',
                            'Admin': 'admin_action',
                            'Subasta': 'auction',
                            'Seguridad': 'security'
                        };
                        const tipoFila = tipoMap[tipoTexto.textContent.trim()];
                        fila.style.display = tipoFila === filtro ? '' : 'none';
                    }
                }
            });
        }

        function exportarAuditoria() {
            const filas = document.querySelectorAll('#tabla-auditoria tr');
            let csv = 'Fecha,Hora,Tipo,Usuario/Entidad,Descripci贸n,Monto,Estado\n';
            
            filas.forEach(function(fila) {
                if (fila.style.display !== 'none') {
                    const celdas = fila.querySelectorAll('td');
                    if (celdas.length > 0) {
                        const valores = Array.from(celdas).map(function(celda) {
                            return '"' + celda.textContent.trim().replace(/"/g, '""') + '"';
                        });
                        csv += valores.join(',') + '\n';
                    }
                }
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'auditoria_nexos_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            URL.revokeObjectURL(url);

            notify.success('Registro de auditor铆a exportado correctamente');
        }

        // Cargar resumen financiero al cargar la p谩gina
        actualizarResumenFinanciero();

        // Actualizar cuando se cambia a la pesta帽a de finanzas
        const originalCambiarTab = cambiarTab;
        cambiarTab = function(tab, element) {
            originalCambiarTab(tab, element);
            if (tab === 'finanzas') {
                actualizarResumenFinanciero();
            }
        };

        // Cerrar modales al hacer clic fuera
        document.getElementById('modal-gestion-finanzas').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalGestionFinanzas();
            }
        });

        document.getElementById('modal-modificar-saldo').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalModificarSaldo();
            }
        });

        // ========== FUNCIONES PARA GESTIN DE RIFAS ==========
        function mostrarModalRifas() {
            const rifas = JSON.parse(localStorage.getItem('nexos_rifas') || '[]');
            
            let html = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;" onclick="if(event.target === this) this.remove()">';
            html += '<div style="background: white; padding: 2rem; border-radius: 20px; max-width: 1200px; width: 90%; max-height: 90vh; overflow-y: auto;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
            html += '<h2 style="margin: 0; color: #333;"><i class="fas fa-ticket-alt"></i> Gesti贸n de Rifas</h2>';
            html += '<button onclick="this.closest(\'.modal\').remove()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #999;">&times;</button>';
            html += '</div>';

            if (rifas.length === 0) {
                html += '<p style="text-align: center; color: #999; padding: 3rem;">No hay rifas creadas</p>';
            } else {
                html += '<div style="display: grid; gap: 1.5rem;">';
                rifas.forEach(rifa => {
                    const vendidos = rifa.boletos ? rifa.boletos.filter(b => b.comprado).length : 0;
                    const porcentaje = (vendidos / rifa.totalBoletos * 100).toFixed(1);
                    const ingresos = vendidos * rifa.precioBoleto;
                    const fechaSorteo = new Date(rifa.fechaSorteo).toLocaleDateString('es-CL');
                    
                    html += '<div style="border: 2px solid #e0e0e0; border-radius: 15px; padding: 1.5rem; display: flex; gap: 1.5rem; align-items: center;">';
                    html += '<img src="' + rifa.imagen + '" style="width: 120px; height: 120px; object-fit: cover; border-radius: 10px;">';
                    html += '<div style="flex: 1;">';
                    html += '<div style="display: flex; gap: 0.5rem; margin-bottom: 0.8rem;">';
                    html += '<span style="background: ' + (rifa.estado === 'activa' ? '#27ae60' : '#95a5a6') + '; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">' + rifa.estado.toUpperCase() + '</span>';
                    html += '</div>';
                    html += '<h3 style="margin: 0 0 0.5rem 0; color: #333;">' + rifa.titulo + '</h3>';
                    html += '<p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem;"> ' + rifa.empresaNombre + '</p>';
                    html += '<p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem;"> ' + rifa.premio + ' ($' + rifa.valorPremio.toLocaleString('es-CL') + ')</p>';
                    html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0;">';
                    html += '<div><strong>Boletos vendidos:</strong><br>' + vendidos + ' / ' + rifa.totalBoletos + ' (' + porcentaje + '%)</div>';
                    html += '<div><strong>Precio boleto:</strong><br>$' + rifa.precioBoleto.toLocaleString('es-CL') + '</div>';
                    html += '<div><strong>Ingresos:</strong><br>$' + ingresos.toLocaleString('es-CL') + '</div>';
                    html += '</div>';
                    html += '<div style="background: #f0f0f0; border-radius: 10px; overflow: hidden; height: 10px;">';
                    html += '<div style="background: #27ae60; height: 100%; width: ' + porcentaje + '%;"></div>';
                    html += '</div>';
                    html += '<p style="margin: 0.8rem 0 0 0; color: #999; font-size: 0.85rem;"><i class="fas fa-calendar"></i> Sorteo: ' + fechaSorteo + '</p>';
                    html += '</div>';
                    html += '<div style="display: flex; flex-direction: column; gap: 0.8rem;">';
                    html += '<button onclick="verCompradores(\'' + rifa.id + '\')" style="background: #3498db; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;"><i class="fas fa-users"></i> Ver Compradores</button>';
                    if (rifa.estado === 'activa' && vendidos === rifa.totalBoletos) {
                        html += '<button onclick="realizarSorteo(\'' + rifa.id + '\')" style="background: #f39c12; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;"><i class="fas fa-trophy"></i> Sortear</button>';
                    }
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            html += '</div></div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }

        function verCompradores(rifaId) {
            const rifas = JSON.parse(localStorage.getItem('nexos_rifas') || '[]');
            const rifa = rifas.find(r => r.id === rifaId);
            if (!rifa) return;

            const boletosComprados = rifa.boletos.filter(b => b.comprado);
            
            let html = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;" onclick="if(event.target === this) this.remove()">';
            html += '<div style="background: white; padding: 2rem; border-radius: 20px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
            html += '<h2 style="margin: 0; color: #333;"><i class="fas fa-users"></i> Compradores - ' + rifa.titulo + '</h2>';
            html += '<button onclick="this.closest(\'.modal\').remove()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #999;">&times;</button>';
            html += '</div>';

            if (boletosComprados.length === 0) {
                html += '<p style="text-align: center; color: #999; padding: 2rem;">No hay boletos vendidos a煤n</p>';
            } else {
                // Agrupar por usuario
                const comprasPorUsuario = {};
                boletosComprados.forEach(boleto => {
                    if (!comprasPorUsuario[boleto.userId]) {
                        comprasPorUsuario[boleto.userId] = {
                            nombre: boleto.userName,
                            boletos: []
                        };
                    }
                    comprasPorUsuario[boleto.userId].boletos.push(boleto.numero);
                });

                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">';
                html += '<th style="padding: 1rem; text-align: left;">Usuario</th>';
                html += '<th style="padding: 1rem; text-align: center;">Boletos</th>';
                html += '<th style="padding: 1rem; text-align: right;">Total</th>';
                html += '</tr></thead><tbody>';

                Object.values(comprasPorUsuario).forEach(compra => {
                    const total = compra.boletos.length * rifa.precioBoleto;
                    html += '<tr style="border-bottom: 1px solid #e0e0e0;">';
                    html += '<td style="padding: 1rem;">' + compra.nombre + '</td>';
                    html += '<td style="padding: 1rem; text-align: center;">' + compra.boletos.length + ' boletos</td>';
                    html += '<td style="padding: 1rem; text-align: right; font-weight: 600;">$' + total.toLocaleString('es-CL') + '</td>';
                    html += '</tr>';
                });

                html += '</tbody></table>';
                
                const totalIngresos = boletosComprados.length * rifa.precioBoleto;
                html += '<div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 10px; text-align: right;">';
                html += '<strong style="font-size: 1.2rem;">Total Recaudado: $' + totalIngresos.toLocaleString('es-CL') + '</strong>';
                html += '</div>';
            }

            html += '</div></div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }

        async function realizarSorteo(rifaId) {
            const confirmado = await confirm('驴Realizar el sorteo ahora? Se seleccionar谩 un ganador aleatorio.');
            if (!confirmado) return;

            const rifas = JSON.parse(localStorage.getItem('nexos_rifas') || '[]');
            const rifa = rifas.find(r => r.id === rifaId);
            if (!rifa) return;

            const boletosVendidos = rifa.boletos.filter(b => b.comprado);
            if (boletosVendidos.length === 0) {
                notify.error('No hay boletos vendidos');
                return;
            }

            // Seleccionar ganador aleatorio
            const ganador = boletosVendidos[Math.floor(Math.random() * boletosVendidos.length)];
            
            rifa.estado = 'finalizada';
            rifa.ganador = {
                userId: ganador.userId,
                userName: ganador.userName,
                numeroBoleto: ganador.numero,
                fechaSorteo: new Date().toISOString()
            };

            localStorage.setItem('nexos_rifas', JSON.stringify(rifas));
            
            notify.success('隆Sorteo realizado! Ganador: ' + ganador.userName + ' - Boleto #' + ganador.numero);
            
            // Cerrar modales y actualizar
            document.querySelectorAll('.modal').forEach(m => m.remove());
            cargarDashboardPrincipal();
        }

        // ========== FUNCIONES PARA GESTIN DE PRODUCTOS ==========
        function mostrarModalProductos() {
            const productos = JSON.parse(localStorage.getItem('nexos_productos') || '[]');
            
            let html = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;" onclick="if(event.target === this) this.remove()">';
            html += '<div style="background: white; padding: 2rem; border-radius: 20px; max-width: 1200px; width: 90%; max-height: 90vh; overflow-y: auto;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
            html += '<h2 style="margin: 0; color: #333;"><i class="fas fa-shopping-bag"></i> Gesti贸n de Productos</h2>';
            html += '<button onclick="this.closest(\'.modal\').remove()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #999;">&times;</button>';
            html += '</div>';

            if (productos.length === 0) {
                html += '<p style="text-align: center; color: #999; padding: 3rem;">No hay productos creados</p>';
            } else {
                // Resumen general
                const totalProductos = productos.length;
                const enStock = productos.filter(p => p.stock > 0).length;
                const agotados = productos.filter(p => p.stock === 0).length;
                const totalVentas = productos.reduce((sum, p) => {
                    return sum + (p.ventas || []).reduce((s, v) => s + v.cantidad, 0);
                }, 0);
                const ingresos = productos.reduce((sum, p) => {
                    return sum + (p.ventas || []).reduce((s, v) => s + (v.cantidad * v.precioUnitario), 0);
                }, 0);

                html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 2rem;">';
                html += '<div style="padding: 1rem; background: #f8f9fa; border-radius: 10px; text-align: center;">';
                html += '<div style="font-size: 2rem; font-weight: 700; color: #3498db;">' + totalProductos + '</div>';
                html += '<div style="font-size: 0.9rem; color: #666;">Total Productos</div>';
                html += '</div>';
                html += '<div style="padding: 1rem; background: #f8f9fa; border-radius: 10px; text-align: center;">';
                html += '<div style="font-size: 2rem; font-weight: 700; color: #27ae60;">' + enStock + '</div>';
                html += '<div style="font-size: 0.9rem; color: #666;">En Stock</div>';
                html += '</div>';
                html += '<div style="padding: 1rem; background: #f8f9fa; border-radius: 10px; text-align: center;">';
                html += '<div style="font-size: 2rem; font-weight: 700; color: #e74c3c;">' + agotados + '</div>';
                html += '<div style="font-size: 0.9rem; color: #666;">Agotados</div>';
                html += '</div>';
                html += '<div style="padding: 1rem; background: #f8f9fa; border-radius: 10px; text-align: center;">';
                html += '<div style="font-size: 2rem; font-weight: 700; color: #f39c12;">' + totalVentas + '</div>';
                html += '<div style="font-size: 0.9rem; color: #666;">Vendidos</div>';
                html += '</div>';
                html += '<div style="padding: 1rem; background: #f8f9fa; border-radius: 10px; text-align: center;">';
                html += '<div style="font-size: 1.5rem; font-weight: 700; color: #9b59b6;">$' + ingresos.toLocaleString('es-CL', {notation: 'compact'}) + '</div>';
                html += '<div style="font-size: 0.9rem; color: #666;">Ingresos</div>';
                html += '</div>';
                html += '</div>';

                html += '<div style="display: grid; gap: 1.5rem;">';
                productos.forEach(producto => {
                    const ventas = producto.ventas || [];
                    const unidadesVendidas = ventas.reduce((sum, v) => sum + v.cantidad, 0);
                    const ingresosProducto = ventas.reduce((sum, v) => sum + (v.cantidad * v.precioUnitario), 0);
                    const descuento = producto.precioOriginal ? Math.round(((producto.precioOriginal - producto.precio) / producto.precioOriginal) * 100) : 0;
                    
                    let stockColor = '#27ae60';
                    let stockTexto = 'En Stock';
                    if (producto.stock === 0) {
                        stockColor = '#e74c3c';
                        stockTexto = 'AGOTADO';
                    } else if (producto.stock <= 5) {
                        stockColor = '#f39c12';
                        stockTexto = 'Stock Bajo';
                    }

                    html += '<div style="border: 2px solid #e0e0e0; border-radius: 15px; padding: 1.5rem; display: flex; gap: 1.5rem; align-items: center;">';
                    html += '<img src="' + producto.imagen + '" style="width: 120px; height: 120px; object-fit: cover; border-radius: 10px;">';
                    html += '<div style="flex: 1;">';
                    html += '<div style="display: flex; gap: 0.5rem; margin-bottom: 0.8rem;">';
                    html += '<span style="background: #e67e22; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">' + producto.categoria + '</span>';
                    html += '<span style="background: ' + stockColor + '; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">' + stockTexto + '</span>';
                    if (descuento > 0) {
                        html += '<span style="background: #e74c3c; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">-' + descuento + '%</span>';
                    }
                    html += '</div>';
                    html += '<h3 style="margin: 0 0 0.5rem 0; color: #333;">' + producto.nombre + '</h3>';
                    html += '<p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem;"> ' + producto.empresaNombre + '</p>';
                    html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 1rem 0;">';
                    html += '<div><strong>Precio:</strong><br>$' + producto.precio.toLocaleString('es-CL') + '</div>';
                    html += '<div><strong>Stock:</strong><br>' + producto.stock + ' unidades</div>';
                    html += '<div><strong>Vendidos:</strong><br>' + unidadesVendidas + ' unidades</div>';
                    html += '<div><strong>Ingresos:</strong><br>$' + ingresosProducto.toLocaleString('es-CL') + '</div>';
                    html += '</div>';
                    html += '</div>';
                    html += '<div style="display: flex; flex-direction: column; gap: 0.8rem;">';
                    html += '<button onclick="verVentas(\'' + producto.id + '\')" style="background: #3498db; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;"><i class="fas fa-chart-line"></i> Ver Ventas</button>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            html += '</div></div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }

        function verVentas(productoId) {
            const productos = JSON.parse(localStorage.getItem('nexos_productos') || '[]');
            const producto = productos.find(p => p.id === productoId);
            if (!producto) return;

            const ventas = producto.ventas || [];
            
            let html = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;" onclick="if(event.target === this) this.remove()">';
            html += '<div style="background: white; padding: 2rem; border-radius: 20px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
            html += '<h2 style="margin: 0; color: #333;"><i class="fas fa-chart-line"></i> Ventas - ' + producto.nombre + '</h2>';
            html += '<button onclick="this.closest(\'.modal\').remove()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #999;">&times;</button>';
            html += '</div>';

            if (ventas.length === 0) {
                html += '<p style="text-align: center; color: #999; padding: 2rem;">No hay ventas registradas</p>';
            } else {
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">';
                html += '<th style="padding: 1rem; text-align: left;">Fecha</th>';
                html += '<th style="padding: 1rem; text-align: left;">Comprador</th>';
                html += '<th style="padding: 1rem; text-align: center;">Cantidad</th>';
                html += '<th style="padding: 1rem; text-align: right;">Precio Unit.</th>';
                html += '<th style="padding: 1rem; text-align: right;">Total</th>';
                html += '</tr></thead><tbody>';

                ventas.forEach(venta => {
                    const fecha = new Date(venta.fecha).toLocaleDateString('es-CL');
                    html += '<tr style="border-bottom: 1px solid #e0e0e0;">';
                    html += '<td style="padding: 1rem;">' + fecha + '</td>';
                    html += '<td style="padding: 1rem;">' + venta.userName + '</td>';
                    html += '<td style="padding: 1rem; text-align: center;">' + venta.cantidad + '</td>';
                    html += '<td style="padding: 1rem; text-align: right;">$' + venta.precioUnitario.toLocaleString('es-CL') + '</td>';
                    html += '<td style="padding: 1rem; text-align: right; font-weight: 600;">$' + venta.total.toLocaleString('es-CL') + '</td>';
                    html += '</tr>';
                });

                html += '</tbody></table>';
                
                const totalUnidades = ventas.reduce((sum, v) => sum + v.cantidad, 0);
                const totalIngresos = ventas.reduce((sum, v) => sum + v.total, 0);
                html += '<div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">';
                html += '<div style="text-align: center;"><strong>Total Unidades Vendidas:</strong><br><span style="font-size: 1.5rem; color: #3498db;">' + totalUnidades + '</span></div>';
                html += '<div style="text-align: center;"><strong>Total Recaudado:</strong><br><span style="font-size: 1.5rem; color: #27ae60;">$' + totalIngresos.toLocaleString('es-CL') + '</span></div>';
                html += '</div>';
            }

            html += '</div></div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>
